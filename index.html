<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    <title>Sistema de Ferramentas Mobile</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="fw_mini.ico">
    <link rel="shortcut icon" href="fw_mini.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="fw_mini.ico">

    <!-- CDNs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- QR Code - M√∫ltiplas fontes para garantir -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Biblioteca para scanner de QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #2980b9;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --gray-color: #95a5a6;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
            --assign-color: #8e44ad;
            --collab-color: #16a085;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            background-color: #f5f7fa;
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        /* Login Screen */
        .login-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .login-box {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 16px;
            padding: 30px 25px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            color: white;
            position: relative;
            overflow: hidden;
        }

        /* Dashboard Mobile */
        .mobile-dashboard {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        .mobile-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            padding: 15px;
            padding-top: calc(15px + env(safe-area-inset-top, 0));
            color: white;
        }

        .mobile-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 70px;
            -webkit-overflow-scrolling: touch;
        }

        .mobile-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            padding: 10px 0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0));
            z-index: 100;
        }

        /* Menu Lateral */
        .mobile-sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background: white;
            z-index: 2000;
            transition: right 0.3s;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }

        .mobile-sidebar.open {
            right: 0;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }

        .menu-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .menu-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .menu-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            color: var(--text-color);
            font-size: 16px;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }

        .menu-item:hover {
            background: var(--light-color);
        }

        .menu-item i {
            margin-right: 12px;
            width: 24px;
            text-align: center;
            color: var(--secondary-color);
        }

        .menu-item.logout {
            color: #ffffff !important;
            background: var(--danger-color) !important;
            margin-top: 10px;
            border-radius: 8px;
        }

        .menu-item.logout i {
            color: #ffffff !important;
        }

        .menu-item.logout:hover,
        .menu-item.logout:active {
            background: #c0392b !important;
        }

        /* Tabs */
        .tab-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            padding: 8px 5px;
            color: var(--gray-color);
            font-size: 11px;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: var(--secondary-color);
        }

        .tab-button i {
            font-size: 18px;
            margin-bottom: 4px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* Miniaturas de Imagens */
        .thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-color);
            font-size: 24px;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-available {
            background: #27ae60;
            color: white;
        }

        .status-in-use {
            background: #3498db;
            color: white;
        }

        .status-maintenance {
            background: #f39c12;
            color: white;
        }

        .status-damaged {
            background: #e74c3c;
            color: white;
        }

        .assignment-card {
            background: #f8f9fa;
            border-left: 4px solid var(--assign-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .my-assignment-card {
            background: #f0f9f7;
            border-left: 4px solid var(--collab-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .my-assignment-card::before {
            content: "MINHA ATRIBUI√á√ÉO";
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--collab-color);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            opacity: 0.8;
        }

        /* Loader */
        .loader {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            transform: translateY(-100%);
            opacity: 0;
            transition: all 0.3s;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        /* Formul√°rio */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: white;
            -webkit-appearance: none;
            appearance: none;
        }

        /* Bot√µes */
        .mobile-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }

        .mobile-btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .mobile-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Scanner */
        .scanner-container {
            width: 100%;
            height: 300px;
            background: var(--light-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 2px solid #00ff00;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
        }

        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #00ff00;
            box-shadow: 0 0 8px #00ff00;
            animation: scan 2s infinite linear;
        }

        @keyframes scan {
            0% {
                top: 0;
            }

            100% {
                top: 100%;
            }
        }

        /* Tool Actions */
        .tool-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-width: 80px;
        }

        .action-btn.view {
            background: var(--secondary-color);
            color: white;
        }

        .action-btn.qr {
            background: #8e44ad;
            color: white;
        }

        .action-btn.assign {
            background: var(--warning-color);
            color: white;
        }

        .action-btn.return {
            background: var(--success-color);
            color: white;
        }

        .action-btn.collab-assign {
            background: var(--collab-color);
            color: white;
        }

        /* Image Preview */
        .image-preview {
            width: 100%;
            height: 200px;
            background: var(--light-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Canvas do Scanner */
        #qr-canvas {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Classe para ocultar elementos sens√≠veis */
        .restricted-hidden {
            display: none !important;
        }

        .restricted-blur {
            filter: blur(5px);
            user-select: none;
            position: relative;
        }

        .restricted-blur::after {
            content: "üîí";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            z-index: 10;
        }

        /* Assignment Step */
        .assignment-step {
            background: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .step-indicator {
            display: flex;
            margin-bottom: 20px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: var(--light-color);
            color: var(--gray-color);
            border-radius: 8px 8px 0 0;
            font-size: 14px;
        }

        .step.active {
            background: var(--assign-color);
            color: white;
        }

        .collaborator-item {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .collaborator-item:hover {
            background: var(--light-color);
            border-color: var(--assign-color);
        }

        .collaborator-item.selected {
            background: #8e44ad20;
            border-color: var(--assign-color);
            border-width: 2px;
        }

        .tool-assignment-info {
            background: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .assignment-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Scanner instructions */
        .scanner-instructions {
            background: var(--collab-color);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .scanner-instructions i {
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* Restricted message */
        .restricted-message {
            background: var(--warning-color);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <div class="login-box">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: center; align-items: center;">
                            <img src="Delservin Logo.PNG" alt="Delservin"
                                style="height: 60px; width: auto; max-width: 200px;"
                                onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'width:120px; height:50px; background:rgba(255,255,255,0.2); border-radius:8px; display:flex; align-items:center; justify-content:center;\'><span style=\'font-weight:bold; font-size:18px; color:white;\'>DELSERVIN</span></div>'">
                        </div>
                    </div>
                </div>

                <div id="loginError" class="notification error"
                    style="display: none; position: relative; top: 0; transform: none; opacity: 1; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-circle"></i> Credenciais inv√°lidas
                </div>

                <div class="form-group">
                    <label for="loginEmail">Email ou Usu√°rio</label>
                    <input type="text" id="loginEmail" placeholder="Seu login" autocapitalize="off"
                        autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha"
                        autocomplete="current-password">
                </div>

                <button type="button" class="mobile-btn mobile-btn-primary" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
            </div>
        </div>

        <!-- Dashboard Mobile -->
        <div id="mobileDashboard" class="mobile-dashboard">
            <!-- Header -->
            <header class="mobile-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h1 style="font-size: 18px; font-weight: bold;">Sistema de Ferramentas</h1>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px; flex-wrap: wrap;">
                            <span id="userBadge"
                                style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px;"></span>
                            <span id="userName"
                                style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 12px;"></span>
                            <span id="connectionStatus"
                                style="background: rgba(231,76,60,0.2); color: #e74c3c; padding: 4px 10px; border-radius: 12px; font-size: 12px;">Offline</span>
                        </div>
                    </div>
                    <button id="menuBtn"
                        style="background: rgba(255,255,255,0.2); border: none; width: 44px; height: 44px; border-radius: 50%; color: white; font-size: 20px;">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>

                <!-- Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; text-align: center;">
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Itens</div>
                        <div style="font-size: 20px; font-weight: bold;" id="totalItems">0/0</div>
                    </div>
                    <div id="totalValueContainer">
                        <div style="font-size: 12px; opacity: 0.9;">Valor</div>
                        <div style="font-size: 20px; font-weight: bold;" id="totalValue">R$ 0</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Status</div>
                        <div style="font-size: 20px; font-weight: bold;" id="syncStatus">Local</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; opacity: 0.9;">Atribu√≠das</div>
                        <div style="font-size: 20px; font-weight: bold;" id="assignedCount">0</div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="mobile-content">
                <!-- Dashboard Tab -->
                <div id="tabDashboard" class="tab-content active">
                    <h2 style="margin-bottom: 20px; font-size: 20px;">Dashboard</h2>

                    <!-- Card de Controle de Sincroniza√ß√£o -->
                    <div id="adminSyncCard" class="card" style="display: block;">
                        <h3 style="margin-bottom: 15px;">Controle de Sincroniza√ß√£o</h3>
                        <div
                            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <button id="syncAllBtn" class="mobile-btn" style="background: #8e44ad; color: white;">
                                <i class="fas fa-database"></i> Buscar Tudo
                            </button>
                            <button id="syncUpdatesBtn" class="mobile-btn" style="background: #3498db; color: white;">
                                <i class="fas fa-sync"></i> S√≥ Atualiza√ß√µes
                            </button>
                        </div>
                        <div style="font-size: 12px; color: var(--gray-color); text-align: center;">
                            <span id="syncInfo">√öltima sincroniza√ß√£o: Nunca</span>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-pie" style="color: var(--secondary-color);"></i>
                            Status dos Itens
                        </h3>
                        <div id="statusStats">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px;">Carregando...</p>
                        </div>
                    </div>

                    <!-- Card para Colaborador - Minhas Atribui√ß√µes -->
                    <div id="collabMyAssignmentsCard" class="card" style="display: none;">
                        <h3 style="margin-bottom: 15px; color: var(--collab-color);">
                            <i class="fas fa-hand-holding-heart"></i> Minhas Ferramentas
                        </h3>
                        <div id="myAssignmentsList">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px;">Nenhuma ferramenta atribu√≠da a voc√™</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 15px;">A√ß√µes R√°pidas</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <button class="mobile-btn" id="addItemBtn"
                                style="background: var(--secondary-color); color: white; display: flex;">
                                <i class="fas fa-plus"></i> Novo Item
                            </button>
                            <button class="mobile-btn" id="assignToolBtn"
                                style="background: var(--assign-color); color: white; display: flex;">
                                <i class="fas fa-hand-holding"></i> Atribuir
                            </button>
                            <button class="mobile-btn" id="collabScanBtn"
                                style="background: var(--collab-color); color: white; display: none;">
                                <i class="fas fa-qrcode"></i> Pegar Ferramenta
                            </button>
                            <button class="mobile-btn" id="syncNowBtn"
                                style="background: var(--success-color); color: white;">
                                <i class="fas fa-sync-alt"></i> Sincronizar
                            </button>
                            <button class="mobile-btn" id="clearCacheBtn"
                                style="background: var(--warning-color); color: white; grid-column: span 2; display: flex;">
                                <i class="fas fa-trash-alt"></i> Limpar Cache
                            </button>
                        </div>
                    </div>

                    <div class="card" id="recentItemsCard">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Itens Recentes</h3>
                            <button id="viewAllBtn"
                                style="background: none; border: none; color: var(--secondary-color); font-size: 14px;">
                                Ver Todos
                            </button>
                        </div>
                        <div id="recentItems">
                            <p style="text-align: center; color: var(--gray-color); padding: 20px;">Nenhum item
                                cadastrado</p>
                        </div>
                    </div>
                </div>

                <!-- Cadastro Tab -->
                <div id="tabCadastro" class="tab-content" style="display: none;">
                    <h2 style="margin-bottom: 20px; font-size: 20px;">Cadastrar Item</h2>
                    <div id="cadastroForm">
                        <!-- Form ser√° carregado aqui -->
                    </div>
                </div>

                <!-- Cat√°logo Tab -->
                <div id="tabCatalogo" class="tab-content" style="display: none;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div style="flex: 1; position: relative;">
                            <i class="fas fa-search"
                                style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray-color);"></i>
                            <input type="text" id="searchInput" placeholder="Buscar por c√≥digo, nome ou patrim√¥nio..."
                                style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 16px;">
                        </div>
                    </div>

                    <div style="margin-bottom: 15px; font-size: 14px; color: var(--gray-color); text-align: center;">
                        <span id="toolsCount">0 de 0 itens carregados</span>
                        <button id="loadMoreBtn"
                            style="background: none; border: none; color: var(--secondary-color); font-size: 14px; margin-left: 10px; display: none;">
                            Carregar mais
                        </button>
                    </div>

                    <div id="toolsList">
                        <!-- Lista ser√° carregada aqui -->
                    </div>
                </div>

                <!-- Scanner Tab -->
                <div id="tabScanner" class="tab-content" style="display: none;">
                    <h2 style="margin-bottom: 20px; font-size: 20px;">Scanner QR Code</h2>

                    <!-- Instru√ß√µes espec√≠ficas para cada tipo de usu√°rio -->
                    <div id="scannerInstructions" class="scanner-instructions" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        <p id="scannerInstructionsText">Aponte para o QR Code da ferramenta</p>
                    </div>

                    <div class="card">
                        <div class="scanner-container" id="scannerContainer">
                            <i class="fas fa-qrcode"
                                style="font-size: 60px; color: var(--gray-color); margin-bottom: 15px;"></i>
                            <p style="text-align: center; color: var(--gray-color);">√Årea do scanner</p>
                            <p style="text-align: center; font-size: 12px; color: var(--gray-color); margin-top: 10px;">
                                Toque para ativar a c√¢mera
                            </p>
                        </div>

                        <div style="text-align: center; margin-top: 20px;">
                            <button id="startScannerBtn" class="mobile-btn"
                                style="background: var(--secondary-color); color: white;">
                                <i class="fas fa-camera"></i> Iniciar Scanner
                            </button>
                            <button id="stopScannerBtn" class="mobile-btn"
                                style="background: var(--danger-color); color: white; display: none;">
                                <i class="fas fa-stop"></i> Parar Scanner
                            </button>
                        </div>

                        <div id="scannerResult" style="margin-top: 20px; display: none;">
                            <h4 style="margin-bottom: 10px;">Resultado:</h4>
                            <div id="scannedData"
                                style="background: var(--light-color); padding: 15px; border-radius: 8px; font-size: 14px;">
                                <!-- Dados escaneados aparecer√£o aqui -->
                            </div>
                            <div style="margin-top: 15px;">
                                <button id="viewScannedItemBtn" class="mobile-btn"
                                    style="background: var(--secondary-color); color: white; display: none;">
                                    <i class="fas fa-eye"></i> Ver Item
                                </button>
                                <button id="assignScannedItemBtn" class="mobile-btn"
                                    style="background: var(--assign-color); color: white; display: none;">
                                    <i class="fas fa-hand-holding"></i> Atribuir Item
                                </button>
                                <button id="collabTakeItemBtn" class="mobile-btn"
                                    style="background: var(--collab-color); color: white; display: none;">
                                    <i class="fas fa-hand-holding-heart"></i> Pegar Ferramenta
                                </button>
                                <button id="scanAgainBtn" class="mobile-btn"
                                    style="background: var(--warning-color); color: white;">
                                    <i class="fas fa-redo"></i> Escanear Novamente
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Atribui√ß√µes Tab -->
                <div id="tabAssignments" class="tab-content" style="display: none;">
                    <h2 style="margin-bottom: 20px; font-size: 20px;" id="assignmentsTitle">Atribui√ß√µes</h2>

                    <!-- Filtros -->
                    <div id="assignmentsFilters" style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button id="showActiveAssignments" class="mobile-btn" style="flex: 1; background: var(--secondary-color); color: white;">
                            <i class="fas fa-clock"></i> Ativas
                        </button>
                        <button id="showAllAssignments" class="mobile-btn" style="flex: 1; background: var(--gray-color); color: white;">
                            <i class="fas fa-history"></i> Todas
                        </button>
                    </div>

                    <div id="assignmentsList">
                        <p style="text-align: center; color: var(--gray-color); padding: 40px;">Carregando atribui√ß√µes...</p>
                    </div>
                </div>

                <!-- Config Tab -->
                <div id="tabConfig" class="tab-content" style="display: none;">
                    <h2 style="margin-bottom: 20px; font-size: 20px;">Configura√ß√µes</h2>

                    <div class="card">
                        <h3 style="margin-bottom: 15px;">Configura√ß√µes do Sistema</h3>

                        <div class="form-group" id="syncLimitGroup">
                            <label for="syncLimit">Limite de itens por sincroniza√ß√£o:</label>
                            <select id="syncLimit" class="form-control">
                                <option value="100">100 itens</option>
                                <option value="500" selected>500 itens</option>
                                <option value="1000">1000 itens</option>
                                <option value="0">Todos os itens</option>
                            </select>
                        </div>

                        <div class="form-group" id="cacheSizeGroup">
                            <label for="cacheSize">Tamanho m√°ximo do cache (MB):</label>
                            <input type="number" id="cacheSize" min="10" max="1000" value="100">
                        </div>

                        <div class="form-group" id="autoSyncGroup">
                            <label for="autoSync">Sincroniza√ß√£o autom√°tica:</label>
                            <select id="autoSync" class="form-control">
                                <option value="disabled">Desativada</option>
                                <option value="enabled" selected>Ativada</option>
                            </select>
                        </div>

                        <button id="saveConfigBtn" class="mobile-btn"
                            style="background: var(--success-color); color: white;">
                            <i class="fas fa-save"></i> Salvar Configura√ß√µes
                        </button>

                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 10px;">Informa√ß√µes do Sistema</h4>
                            <div style="font-size: 14px;">
                                <p><strong>Vers√£o:</strong> 2.0.0</p>
                                <p><strong>Itens locais:</strong> <span id="localItemsCount">0</span></p>
                                <p><strong>Atribui√ß√µes ativas:</strong> <span id="localAssignmentsCount">0</span></p>
                                <p><strong>√öltima sincroniza√ß√£o:</strong> <span id="lastSyncTime">Nunca</span></p>
                                <p><strong>Armazenamento usado:</strong> <span id="storageUsed">0 MB</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loader -->
                <div id="loader" class="loader"></div>
            </div>

            <!-- Footer Tabs (ser√° gerado dinamicamente) -->
            <footer class="mobile-footer" id="mobileFooter">
                <!-- Os bot√µes ser√£o gerados dinamicamente via JavaScript -->
            </footer>
        </div>

        <!-- Menu Lateral -->
        <div id="menuOverlay" class="menu-overlay"></div>
        <div id="mobileSidebar" class="mobile-sidebar">
            <div class="menu-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div
                        style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h3 id="menuUserName">Usu√°rio</h3>
                        <p id="menuUserEmail" style="font-size: 14px; opacity: 0.9;">email@exemplo.com</p>
                        <p id="menuUserRole"
                            style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; display: inline-block;">
                            DEV</p>
                    </div>
                </div>
            </div>

            <div class="menu-content">
                <button class="menu-item" onclick="showUserProfile()">
                    <i class="fas fa-user-circle"></i> Meu Perfil
                </button>
                <button class="menu-item" onclick="switchTab('config')">
                    <i class="fas fa-cog"></i> Configura√ß√µes
                </button>
                <button class="menu-item" onclick="showAbout()">
                    <i class="fas fa-info-circle"></i> Sobre o Sistema
                </button>
                <button class="menu-item" onclick="showHelp()">
                    <i class="fas fa-question-circle"></i> Ajuda
                </button>

                <!-- Itens de administra√ß√£o -->
                <div id="adminMenuItems">
                    <div
                        style="margin: 20px 0; padding: 0 15px; font-size: 12px; color: var(--gray-color); text-transform: uppercase;">
                        Administra√ß√£o
                    </div>

                    <button class="menu-item" onclick="manageUsers()">
                        <i class="fas fa-users"></i> Gerenciar Usu√°rios
                    </button>
                    <button class="menu-item" onclick="showReports()">
                        <i class="fas fa-chart-bar"></i> Relat√≥rios
                    </button>
                    <button class="menu-item" onclick="backupData()">
                        <i class="fas fa-database"></i> Backup de Dados
                    </button>
                </div>
            </div>

            <div class="menu-footer">
                <button class="menu-item logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Sair do Sistema
                </button>
            </div>
        </div>

        <!-- Modal para Atribui√ß√£o de Ferramenta -->
        <div id="assignModal" class="modal-overlay">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px;" id="assignModalTitle">Atribuir Ferramenta</h3>
                    <button id="closeAssignModalBtn"
                        style="background: none; border: none; font-size: 20px; color: var(--gray-color);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="assignModalBody">
                    <!-- Conte√∫do do modal ser√° carregado aqui -->
                </div>
            </div>
        </div>

        <!-- Modal para Detalhes do Item -->
        <div id="itemModal" class="modal-overlay">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px;" id="modalTitle">Detalhes do Item</h3>
                    <button id="closeModalBtn"
                        style="background: none; border: none; font-size: 20px; color: var(--gray-color);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="modalBody">
                    <!-- Conte√∫do do modal ser√° carregado aqui -->
                </div>
            </div>
        </div>

        <!-- Modal QR Code -->
        <div id="qrModal" class="modal-overlay">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px;">QR Code do Item</h3>
                    <button id="closeQRModalBtn"
                        style="background: none; border: none; font-size: 20px; color: var(--gray-color);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="qrModalBody" style="text-align: center;">
                    <!-- QR Code ser√° gerado aqui -->
                </div>
            </div>
        </div>

        <!-- Notification Toast -->
        <div id="notification" class="notification">
            <div id="notificationContent"></div>
        </div>
    </div>

    <!-- Canvas oculto para processamento do QR Code -->
    <canvas id="qr-canvas" style="display: none;"></canvas>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO SUPABASE
        // ============================================
        const SUPABASE_CONFIG = {
            url: 'https://eokhafnfmynhridksnuh.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVva2hhZm5mbXluaHJpZGtzbnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzYwMDIsImV4cCI6MjA4NTcxMjAwMn0.-RZtzUYpdOI4_WKOmP9lqw9guJmvh8XFeAL6UXhA4vo'
        };

        // ============================================
        // VARI√ÅVEIS GLOBAIS
        // ============================================
        let currentUser = null;
        let tools = [];
        let collaborators = [];
        let assignments = [];
        let supabaseClient = null;
        let isOnline = navigator.onLine;
        let currentTab = 'dashboard';
        let db = null;
        let loadedToolsCount = 0;
        let totalToolsInDB = 0;
        let scannerActive = false;
        let videoStream = null;
        let scanningInterval = null;
        let currentScannedData = null;
        let currentScannedTool = null;
        let searchTimeout = null;
        let assignmentInProgress = null;

        // ============================================
        // FUN√á√ïES DE VERIFICA√á√ÉO DE PERFIL
        // ============================================
        function getUserRole() {
            if (!currentUser) return null;
            return currentUser.role;
        }

        function isAdmin() {
            const role = getUserRole();
            return role === 'dev' || role === 'admin' || role === 'almoxarife';
        }

        function isOperator() {
            const role = getUserRole();
            return role === 'user' || role === 'operador';
        }

        function isCollaborator() {
            const role = getUserRole();
            return role === 'collaborator' || role === 'colaborador';
        }

        // ============================================
        // FUN√á√ÉO PARA CONFIGURAR INTERFACE POR PERFIL
        // ============================================
        function setupInterfaceByRole() {
            const role = getUserRole();
            
            // Configurar footer tabs
            configureFooterTabs(role);
            
            // Configurar cards e bot√µes
            configureDashboardCards(role);
            
            // Configurar menu lateral
            configureSidebar(role);
            
            // Configurar mensagens e instru√ß√µes
            configureScannerInstructions(role);
        }

        function configureFooterTabs(role) {
            const footer = document.getElementById('mobileFooter');
            let tabsHtml = '';

            if (isAdmin()) {
                // Admin: todas as tabs
                tabsHtml = `
                    <button class="tab-button active" data-tab="dashboard">
                        <i class="fas fa-home"></i>
                        <span>In√≠cio</span>
                    </button>
                    <button class="tab-button" data-tab="cadastro">
                        <i class="fas fa-plus-circle"></i>
                        <span>Novo</span>
                    </button>
                    <button class="tab-button" data-tab="catalogo">
                        <i class="fas fa-list"></i>
                        <span>Itens</span>
                    </button>
                    <button class="tab-button" data-tab="scanner">
                        <i class="fas fa-qrcode"></i>
                        <span>Scanner</span>
                    </button>
                    <button class="tab-button" data-tab="assignments">
                        <i class="fas fa-hand-holding"></i>
                        <span>Atribui√ß√µes</span>
                    </button>
                    <button class="tab-button" data-tab="config">
                        <i class="fas fa-cog"></i>
                        <span>Config</span>
                    </button>
                `;
            } else if (isOperator()) {
                // Operador: dashboard, cat√°logo, scanner, atribui√ß√µes e config
                tabsHtml = `
                    <button class="tab-button active" data-tab="dashboard">
                        <i class="fas fa-home"></i>
                        <span>In√≠cio</span>
                    </button>
                    <button class="tab-button" data-tab="catalogo">
                        <i class="fas fa-list"></i>
                        <span>Itens</span>
                    </button>
                    <button class="tab-button" data-tab="scanner">
                        <i class="fas fa-qrcode"></i>
                        <span>Scanner</span>
                    </button>
                    <button class="tab-button" data-tab="assignments">
                        <i class="fas fa-hand-holding"></i>
                        <span>Atribui√ß√µes</span>
                    </button>
                    <button class="tab-button" data-tab="config">
                        <i class="fas fa-cog"></i>
                        <span>Config</span>
                    </button>
                `;
            } else if (isCollaborator()) {
                // Colaborador: dashboard, scanner, minhas atribui√ß√µes e config
                tabsHtml = `
                    <button class="tab-button active" data-tab="dashboard">
                        <i class="fas fa-home"></i>
                        <span>In√≠cio</span>
                    </button>
                    <button class="tab-button" data-tab="scanner">
                        <i class="fas fa-qrcode"></i>
                        <span>Scanner</span>
                    </button>
                    <button class="tab-button" data-tab="assignments">
                        <i class="fas fa-hand-holding-heart"></i>
                        <span>Minhas</span>
                    </button>
                    <button class="tab-button" data-tab="config">
                        <i class="fas fa-cog"></i>
                        <span>Config</span>
                    </button>
                `;
            }

            footer.innerHTML = tabsHtml;

            // Reaplicar eventos
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', function () {
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                });
            });
        }

        function configureDashboardCards(role) {
            // Card de sincroniza√ß√£o admin
            document.getElementById('adminSyncCard').style.display = isAdmin() ? 'block' : 'none';
            
            // Card de minhas atribui√ß√µes para colaborador
            document.getElementById('collabMyAssignmentsCard').style.display = isCollaborator() ? 'block' : 'none';
            
            // Bot√£o de novo item
            document.getElementById('addItemBtn').style.display = isAdmin() ? 'flex' : 'none';
            
            // Bot√£o de atribuir
            document.getElementById('assignToolBtn').style.display = isAdmin() ? 'flex' : 'none';
            
            // Bot√£o para colaborador pegar ferramenta
            document.getElementById('collabScanBtn').style.display = isCollaborator() ? 'flex' : 'none';
            
            // Bot√£o de limpar cache
            document.getElementById('clearCacheBtn').style.display = isAdmin() ? 'flex' : 'none';
            
            // Valor total - admins e operadores veem
            const totalValueContainer = document.getElementById('totalValueContainer');
            if (!isAdmin() && !isOperator()) {
                totalValueContainer.style.display = 'none';
            }
        }

        function configureSidebar(role) {
            const adminMenuItems = document.getElementById('adminMenuItems');
            if (adminMenuItems) {
                adminMenuItems.style.display = isAdmin() ? 'block' : 'none';
            }
        }

        function configureScannerInstructions(role) {
            const instructionsDiv = document.getElementById('scannerInstructions');
            const instructionsText = document.getElementById('scannerInstructionsText');
            
            if (isCollaborator()) {
                instructionsDiv.style.display = 'block';
                instructionsText.innerHTML = 'Aponte para o QR Code da ferramenta que deseja pegar. A ferramenta ser√° atribu√≠da automaticamente a voc√™.';
            } else if (isOperator()) {
                instructionsDiv.style.display = 'block';
                instructionsText.innerHTML = 'Aponte para o QR Code para visualizar detalhes da ferramenta.';
            } else if (isAdmin()) {
                instructionsDiv.style.display = 'block';
                instructionsText.innerHTML = 'Aponte para o QR Code da ferramenta. Voc√™ pode atribu√≠-la a um colaborador.';
            } else {
                instructionsDiv.style.display = 'none';
            }
        }

        // ============================================
        // FUN√á√ïES ESPEC√çFICAS PARA COLABORADOR
        // ============================================
        function loadMyAssignments() {
            if (!isCollaborator() || !currentUser) return [];
            
            const myAssignments = assignments.filter(a => 
                a.status === 'active' && 
                (a.collaborator_id == currentUser.collaboratorId || 
                 a.assigned_to_id == currentUser.collaboratorId)
            );
            
            return myAssignments;
        }

        function updateMyAssignmentsCard() {
            if (!isCollaborator()) return;
            
            const myAssignments = loadMyAssignments();
            const listElement = document.getElementById('myAssignmentsList');
            
            if (myAssignments.length === 0) {
                listElement.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px;">Nenhuma ferramenta atribu√≠da a voc√™</p>';
                return;
            }
            
            let html = '';
            myAssignments.forEach(assignment => {
                const tool = tools.find(t => t.id == assignment.tool_id);
                if (!tool) return;
                
                html += `
                    <div class="my-assignment-card">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="thumbnail" style="width: 40px; height: 40px;">
                                ${tool.image ? `<img src="${tool.image}" alt="${tool.name}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">` : '<i class="fas fa-tools"></i>'}
                            </div>
                            <div style="flex: 1;">
                                <h4 style="font-size: 14px;">${tool.name}</h4>
                                <p style="font-size: 12px; color: var(--gray-color);">${tool.code}</p>
                                <p style="font-size: 11px; color: var(--gray-color);">Atribu√≠do em: ${formatDate(assignment.assignment_date)}</p>
                            </div>
                        </div>
                        <button class="mobile-btn" onclick="returnMyTool('${assignment.id}')" style="margin-top: 10px; background: var(--success-color); color: white; font-size: 14px;">
                            <i class="fas fa-undo-alt"></i> Devolver Ferramenta
                        </button>
                    </div>
                `;
            });
            
            listElement.innerHTML = html;
        }

        async function returnMyTool(assignmentId) {
            if (!isCollaborator()) return;
            
            if (!confirm('Tem certeza que deseja devolver esta ferramenta?')) return;
            
            try {
                const assignment = assignments.find(a => a.id == assignmentId);
                if (!assignment) {
                    showNotification('Atribui√ß√£o n√£o encontrada', 'error');
                    return;
                }
                
                // Atualizar atribui√ß√£o
                assignment.status = 'returned';
                assignment.user_returned = currentUser.name;
                assignment.actual_return_date = new Date().toISOString().split('T')[0];
                assignment.updated_at = new Date().toISOString();
                assignment.sync_status = isOnline ? 'synced' : 'pending';
                
                // Atualizar no Supabase se estiver online
                if (isOnline && supabaseClient) {
                    try {
                        const { error } = await supabaseClient
                            .from('tool_assignments')
                            .update({
                                status: 'returned',
                                user_returned: currentUser.name,
                                actual_return_date: assignment.actual_return_date,
                                updated_at: assignment.updated_at
                            })
                            .eq('id', assignment.id);
                            
                        if (error) throw error;
                    } catch (error) {
                        console.error('Erro ao atualizar atribui√ß√£o no Supabase:', error);
                        assignment.sync_status = 'pending';
                    }
                }
                
                // Atualizar status da ferramenta
                await updateToolStatus(assignment.tool_id, 'Dispon√≠vel');
                
                showNotification('Ferramenta devolvida com sucesso!', 'success');
                
                // Atualizar interface
                updateMyAssignmentsCard();
                updateUI();
                
            } catch (error) {
                console.error('Erro ao devolver ferramenta:', error);
                showNotification('Erro ao devolver ferramenta', 'error');
            }
        }

        async function takeToolAsCollaborator(toolId) {
            if (!isCollaborator() || !currentUser || !currentUser.collaboratorId) {
                showNotification('Perfil de colaborador n√£o configurado corretamente', 'error');
                return false;
            }
            
            try {
                // Buscar ferramenta
                const tool = tools.find(t => t.id == toolId);
                if (!tool) {
                    showNotification('Ferramenta n√£o encontrada', 'error');
                    return false;
                }
                
                // Verificar se ferramenta est√° dispon√≠vel
                if (tool.status !== 'Dispon√≠vel' && tool.status !== 'Disponivel') {
                    showNotification('Esta ferramenta n√£o est√° dispon√≠vel', 'error');
                    return false;
                }
                
                // Verificar se j√° est√° atribu√≠da
                const activeAssignment = assignments.find(a => a.tool_id == toolId && a.status === 'active');
                if (activeAssignment) {
                    showNotification('Esta ferramenta j√° est√° atribu√≠da a algu√©m', 'error');
                    return false;
                }
                
                // Verificar se o colaborador j√° tem ferramentas atribu√≠das (limite de 3)
                const myActiveAssignments = loadMyAssignments();
                if (myActiveAssignments.length >= 3) {
                    showNotification('Voc√™ j√° tem 3 ferramentas atribu√≠das. Devolva uma antes de pegar outra.', 'warning');
                    return false;
                }
                
                // Criar nova atribui√ß√£o
                const newAssignment = {
                    id: Date.now().toString(),
                    tool_id: tool.id.toString(),
                    tool_code: tool.code,
                    tool_name: tool.name,
                    collaborator_id: currentUser.collaboratorId.toString(),
                    collaborator_registration: currentUser.registration || 'N/A',
                    collaborator_name: currentUser.name,
                    assignment_date: new Date().toISOString().split('T')[0],
                    assignment_type: 'collaborator',
                    assigned_to_type: 'colaborador',
                    assigned_to_id: currentUser.collaboratorId.toString(),
                    assigned_to_name: currentUser.name,
                    status: 'active',
                    observations: 'Auto-atribui√ß√£o via QR Code',
                    user_assigned: 'Sistema (Auto-atribui√ß√£o)',
                    user_returned: null,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    returned_date: null,
                    expected_return_date: null,
                    actual_return_date: null,
                    local_id: Date.now().toString(),
                    sync_status: isOnline ? 'synced' : 'pending',
                    source: 'collaborator_scan'
                };
                
                // Salvar no Supabase se estiver online
                if (isOnline && supabaseClient) {
                    try {
                        const { error } = await supabaseClient
                            .from('tool_assignments')
                            .insert([newAssignment]);
                            
                        if (error) throw error;
                    } catch (error) {
                        console.error('Erro ao salvar atribui√ß√£o no Supabase:', error);
                        newAssignment.sync_status = 'pending';
                    }
                } else {
                    newAssignment.sync_status = 'pending';
                }
                
                // Adicionar √† lista local
                assignments.unshift(newAssignment);
                
                // Atualizar status da ferramenta
                tool.status = 'Em Uso';
                await updateToolStatus(tool.id, 'Em Uso');
                
                showNotification(`Ferramenta atribu√≠da a voc√™ com sucesso!`, 'success');
                
                // Atualizar interface
                updateMyAssignmentsCard();
                updateUI();
                
                return true;
                
            } catch (error) {
                console.error('Erro ao pegar ferramenta:', error);
                showNotification('Erro ao pegar ferramenta', 'error');
                return false;
            }
        }

        // ============================================
        // FUN√á√ïES DO SCANNER QR CODE (MODIFICADAS)
        // ============================================
        function handleQRCodeDetected(data) {
            try {
                console.log('========== QR CODE DETECTADO ==========');
                console.log('Conte√∫do bruto:', data);

                stopScanner();

                if (data.includes('?item=')) {
                    const urlParams = new URLSearchParams(data.split('?')[1]);
                    let itemId = urlParams.get('item');

                    console.log('ID extra√≠do da URL:', itemId);

                    showNotification('Buscando item...', 'info');

                    buscarItemLocal(itemId).then(toolLocal => {
                        if (toolLocal) {
                            console.log('‚úÖ Item encontrado localmente!');
                            currentScannedTool = toolLocal;
                            showScannedToolResultForRole(toolLocal);
                        } else {
                            console.log('‚ùå Item n√£o encontrado localmente, buscando no Supabase...');
                            showNotification('Item n√£o est√° no cache. Buscando na nuvem...', 'warning');
                            buscarItemNoSupabase(itemId, null, (tool) => {
                                currentScannedTool = tool;
                                showScannedToolResultForRole(tool);
                            });
                        }
                    });
                }
                else if (data.startsWith('{') && (data.includes('"id"') || data.includes('"cod"'))) {
                    try {
                        const parsedData = JSON.parse(data);
                        const itemId = parsedData.id || parsedData.cod;

                        if (itemId) {
                            buscarItemLocal(itemId).then(toolLocal => {
                                if (toolLocal) {
                                    currentScannedTool = toolLocal;
                                    showScannedToolResultForRole(toolLocal);
                                } else {
                                    showNotification('Buscando item antigo na nuvem...', 'info');
                                    buscarItemNoSupabase(itemId, parsedData, (tool) => {
                                        currentScannedTool = tool;
                                        showScannedToolResultForRole(tool);
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        showTextQRCode(data);
                    }
                }
                else {
                    showTextQRCode(data);
                }

            } catch (error) {
                console.error('Erro ao processar QR Code:', error);
                showNotification('Erro ao processar QR Code', 'error');
                showTextQRCode(data);
            }
        }

        function showScannedToolResultForRole(tool) {
            currentScannedData = tool;
            
            const scannedDataDiv = document.getElementById('scannedData');
            const viewBtn = document.getElementById('viewScannedItemBtn');
            const assignBtn = document.getElementById('assignScannedItemBtn');
            const collabTakeBtn = document.getElementById('collabTakeItemBtn');
            
            // Verificar se ferramenta j√° est√° atribu√≠da
            const activeAssignment = assignments.find(a => a.tool_id == tool.id && a.status === 'active');
            const isAvailable = tool.status === 'Dispon√≠vel' || tool.status === 'Disponivel';
            
            let statusHtml = '';
            if (activeAssignment) {
                statusHtml = `<p style="color: var(--danger-color); margin-top: 10px;"><i class="fas fa-exclamation-triangle"></i> Esta ferramenta est√° com ${activeAssignment.collaborator_name}</p>`;
            } else if (!isAvailable) {
                statusHtml = `<p style="color: var(--warning-color); margin-top: 10px;"><i class="fas fa-exclamation-triangle"></i> Status: ${tool.status}</p>`;
            }

            scannedDataDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <div class="thumbnail" style="width: 50px; height: 50px;">
                        ${tool.image ? `<img src="${tool.image}" alt="${tool.name}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">` : '<i class="fas fa-tools"></i>'}
                    </div>
                    <div style="flex:1;">
                        <h4>${tool.name}</h4>
                        <p style="color: var(--gray-color); font-size: 12px;">${tool.code} | ${tool.location}</p>
                    </div>
                </div>
                <p><strong>Status:</strong> <span style="color: ${getStatusColor(tool.status)}">${tool.status}</span></p>
                <p><strong>Localiza√ß√£o:</strong> ${tool.location}</p>
                ${statusHtml}
            `;
            
            // Configurar bot√µes conforme perfil
            viewBtn.style.display = 'block';
            
            if (isAdmin() && isAvailable && !activeAssignment) {
                assignBtn.style.display = 'block';
            } else {
                assignBtn.style.display = 'none';
            }
            
            if (isCollaborator() && isAvailable && !activeAssignment) {
                collabTakeBtn.style.display = 'block';
            } else {
                collabTakeBtn.style.display = 'none';
            }
            
            document.getElementById('scannerResult').style.display = 'block';
        }

        // ============================================
        // FUN√á√ïES DE LISTAGEM DE ATRIBUI√á√ïES (MODIFICADAS)
        // ============================================
        function showAssignmentsList(showActive = true) {
            const listElement = document.getElementById('assignmentsList');
            const titleElement = document.getElementById('assignmentsTitle');
            const filtersElement = document.getElementById('assignmentsFilters');
            
            if (isCollaborator()) {
                // Colaborador v√™ apenas suas pr√≥prias atribui√ß√µes
                titleElement.textContent = 'Minhas Atribui√ß√µes';
                filtersElement.style.display = 'none';
                
                const myAssignments = loadMyAssignments();
                
                if (myAssignments.length === 0) {
                    listElement.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px 20px;">
                            <i class="fas fa-clipboard-list" style="font-size: 60px; color: var(--gray-color); margin-bottom: 20px;"></i>
                            <p style="color: var(--gray-color);">Voc√™ n√£o tem ferramentas atribu√≠das</p>
                            <button class="mobile-btn" onclick="switchTab('scanner')" style="background: var(--collab-color); color: white; margin-top: 15px;">
                                <i class="fas fa-qrcode"></i> Escanear para pegar
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                myAssignments.forEach(assignment => {
                    const tool = tools.find(t => t.id == assignment.tool_id);
                    if (!tool) return;
                    
                    html += `
                        <div class="my-assignment-card">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <div class="thumbnail" style="width: 50px; height: 50px;">
                                    ${tool.image ? `<img src="${tool.image}" alt="${tool.name}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">` : '<i class="fas fa-tools"></i>'}
                                </div>
                                <div style="flex: 1;">
                                    <h4>${tool.name}</h4>
                                    <p style="color: var(--gray-color);">${tool.code}</p>
                                </div>
                            </div>
                            <p><i class="fas fa-calendar" style="width: 20px; color: var(--gray-color);"></i> Atribui√ß√£o: ${formatDate(assignment.assignment_date)}</p>
                            <button class="mobile-btn" onclick="returnMyTool('${assignment.id}')" style="margin-top: 10px; background: var(--success-color); color: white;">
                                <i class="fas fa-undo-alt"></i> Devolver Ferramenta
                            </button>
                        </div>
                    `;
                });
                
                listElement.innerHTML = html;
                
            } else {
                // Admin ou operador v√™ todas as atribui√ß√µes
                titleElement.textContent = 'Atribui√ß√µes de Ferramentas';
                filtersElement.style.display = 'flex';
                
                let filteredAssignments = showActive 
                    ? assignments.filter(a => a.status === 'active')
                    : assignments;
                
                if (filteredAssignments.length === 0) {
                    listElement.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px 20px;">
                            <i class="fas fa-clipboard-list" style="font-size: 60px; color: var(--gray-color); margin-bottom: 20px;"></i>
                            <p style="color: var(--gray-color);">Nenhuma atribui√ß√£o ${showActive ? 'ativa' : ''} encontrada</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                filteredAssignments.forEach(assignment => {
                    const tool = tools.find(t => t.id == assignment.tool_id);
                    const isActive = assignment.status === 'active';
                    
                    html += `
                        <div class="assignment-card" style="border-left-color: ${isActive ? 'var(--assign-color)' : 'var(--gray-color)'};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h4>${assignment.tool_name}</h4>
                                <span class="status-badge ${isActive ? 'status-in-use' : 'status-available'}">
                                    ${isActive ? 'ATIVA' : 'FINALIZADA'}
                                </span>
                            </div>
                            
                            <p><i class="fas fa-user" style="width: 20px; color: var(--gray-color);"></i> ${assignment.collaborator_name}</p>
                            <p><i class="fas fa-calendar" style="width: 20px; color: var(--gray-color);"></i> Atribui√ß√£o: ${formatDate(assignment.assignment_date)}</p>
                            
                            ${assignment.actual_return_date ? 
                                `<p><i class="fas fa-calendar-check" style="width: 20px; color: var(--gray-color);"></i> Devolu√ß√£o: ${formatDate(assignment.actual_return_date)}</p>` : 
                                ''}
                            
                            <p><i class="fas fa-user-tag" style="width: 20px; color: var(--gray-color);"></i> Respons√°vel: ${assignment.user_assigned}</p>
                            
                            ${isActive && isAdmin() ? 
                                `<button class="mobile-btn" onclick="returnTool('${assignment.id}')" style="margin-top: 15px; background: var(--success-color); color: white;">
                                    <i class="fas fa-undo-alt"></i> Registrar Devolu√ß√£o
                                </button>` : 
                                ''}
                        </div>
                    `;
                });
                
                listElement.innerHTML = html;
            }
        }

        // ============================================
        // FUN√á√ïES DE ATUALIZA√á√ÉO DE UI
        // ============================================
        function updateUI() {
            const totalInDB = localStorage.getItem('totalItems') || tools.length;
            document.getElementById('totalItems').textContent = `${tools.length}/${totalInDB}`;

            // Atualizar contador de atribui√ß√µes ativas
            const activeCount = assignments.filter(a => a.status === 'active').length;
            document.getElementById('assignedCount').textContent = activeCount;
            document.getElementById('localAssignmentsCount').textContent = assignments.length;

            // Atualizar valor total (se permitido)
            if (isAdmin() || isOperator()) {
                const totalValue = tools.reduce((sum, tool) => {
                    const preco = parseFloat(tool.preco) || 0;
                    const quantidade = parseInt(tool.quantidade) || 1;
                    return sum + (preco * quantidade);
                }, 0);

                document.getElementById('totalValue').textContent =
                    new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(totalValue);
            }

            updateStatusStats();
            updateRecentItems();
            
            // Atualizar minhas atribui√ß√µes se for colaborador
            if (isCollaborator()) {
                updateMyAssignmentsCard();
            }

            if (currentTab === 'catalogo') {
                updateToolsList();
            } else if (currentTab === 'assignments') {
                showAssignmentsList(true);
            }
        }

        function updateStatusStats() {
            const statsElement = document.getElementById('statusStats');

            if (tools.length === 0) {
                statsElement.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 20px;">Nenhum item cadastrado</p>';
                return;
            }

            const stats = {
                'Dispon√≠vel': 0,
                'Em Uso': 0,
                'Manuten√ß√£o': 0,
                'Danificado': 0,
                'Outro': 0
            };

            tools.forEach(tool => {
                if (stats[tool.status] !== undefined) {
                    stats[tool.status]++;
                } else {
                    stats['Outro']++;
                }
            });

            let html = '';
            const total = tools.length;

            for (const [status, count] of Object.entries(stats)) {
                if (count > 0) {
                    const percent = Math.round((count / total) * 100);
                    const color = getStatusColor(status);

                    html += `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px;">
                                <span>${status}</span>
                                <span>${count} (${percent}%)</span>
                            </div>
                            <div style="height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percent}%; height: 100%; background: ${color};"></div>
                            </div>
                        </div>
                    `;
                }
            }

            statsElement.innerHTML = html;
        }

        function updateRecentItems() {
            const recentElement = document.getElementById('recentItems');
            
            // Para colaborador, mostrar apenas se tiver itens
            if (isCollaborator()) {
                const myAssignments = loadMyAssignments();
                if (myAssignments.length > 0) {
                    recentElement.innerHTML = '<p style="text-align: center; color: var(--collab-color);">Voc√™ tem ferramentas atribu√≠das. Veja em "Minhas".</p>';
                    return;
                }
            }
            
            const recent = tools.slice(0, 5);

            if (recent.length === 0) {
                recentElement.innerHTML = '<p style="text-align: center; color: var(--gray-color);">Nenhum item recente</p>';
                return;
            }

            let html = '';
            recent.forEach(tool => {
                const thumbnailHTML = tool.image ?
                    `<img src="${tool.image}" alt="${tool.name}" style="width:40px;height:40px;border-radius:8px;object-fit:cover;" onerror="this.parentElement.innerHTML='<i class=\'fas fa-tools\'></i>'">` :
                    `<i class="fas fa-tools"></i>`;

                // Verificar se est√° atribu√≠do
                const activeAssignment = assignments.find(a => a.tool_id == tool.id && a.status === 'active');

                html += `
                    <div style="display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0;">
                        <div class="thumbnail" style="width: 40px; height: 40px; margin-right: 12px;">
                            ${thumbnailHTML}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 14px;">${tool.name}</div>
                            <div style="font-size: 12px; color: var(--gray-color);">${tool.code} | ${tool.location}</div>
                            ${activeAssignment ? 
                                `<div style="font-size: 11px; color: var(--assign-color);"><i class="fas fa-hand-holding"></i> ${activeAssignment.collaborator_name}</div>` : 
                                ''}
                        </div>
                        <div style="font-size: 14px; font-weight: 500; color: ${getStatusColor(tool.status)};">
                            ${tool.status}
                        </div>
                    </div>
                `;
            });

            recentElement.innerHTML = html;
        }

        function updateSyncInfo() {
            const lastSync = localStorage.getItem('lastSync');
            const totalItems = localStorage.getItem('totalItems') || '?';
            const syncInfo = document.getElementById('syncInfo');

            if (syncInfo) {
                if (lastSync) {
                    const date = new Date(lastSync);
                    syncInfo.textContent =
                        `√öltima: ${date.toLocaleDateString()} ${date.toLocaleTimeString()} | Total: ${totalItems} itens`;
                } else {
                    syncInfo.textContent = '√öltima sincroniza√ß√£o: Nunca';
                }
            }
        }

        // ============================================
        // FUN√á√ïES DE LOGIN
        // ============================================
        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            const users = {
                // Admins
                'fabio@fwcompany.com.br': {
                    password: 'FabioFW123@',
                    role: 'dev',
                    name: 'F√°bio Mendes',
                    email: 'fabio@fwcompany.com.br',
                    collaboratorId: null
                },
                'emerson.silva@fwcompany.com.br': {
                    password: 'EmersonFW1@',
                    role: 'almoxarife',
                    name: 'Emerson Silva',
                    email: 'emerson.silva@fwcompany.com.br',
                    collaboratorId: null
                },
                'raquel@fwcompany.com.br': {
                    password: 'RaqueL1234',
                    role: 'dev',
                    name: 'Raquel',
                    email: 'raquel@fwcompany.com.br',
                    collaboratorId: null
                },
                
                // Operadores (usu√°rios gen√©ricos)
                'fwuser': {
                    password: 'User123',
                    role: 'user',
                    name: 'Operador Gen√©rico',
                    email: 'fwuser@fwcompany.com.br',
                    collaboratorId: null
                },
                'operador1': {
                    password: 'Operador123',
                    role: 'operador',
                    name: 'Jo√£o Operador',
                    email: 'joao.operador@fwcompany.com.br',
                    collaboratorId: null
                },
                
                // Colaboradores (podem pegar ferramentas)
                'carlos.colaborador': {
                    password: 'Carlos123',
                    role: 'collaborator',
                    name: 'Carlos Silva',
                    email: 'carlos@obra.com',
                    registration: 'COL-001',
                    collaboratorId: 'col-001'
                },
                'ana.colaboradora': {
                    password: 'Ana123',
                    role: 'collaborator',
                    name: 'Ana Souza',
                    email: 'ana@obra.com',
                    registration: 'COL-002',
                    collaboratorId: 'col-002'
                },
                'pedro.obra': {
                    password: 'Pedro123',
                    role: 'collaborator',
                    name: 'Pedro Santos',
                    email: 'pedro@obra.com',
                    registration: 'COL-003',
                    collaboratorId: 'col-003'
                },
            };

            if (users[email] && users[email].password === password) {
                currentUser = users[email];
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Configurar interface baseada no papel
                setupInterfaceByRole();
                
                showDashboard();
                initializeSystem();
            } else {
                showNotification('Credenciais inv√°lidas', 'error');
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mobileDashboard').style.display = 'flex';

            if (currentUser) {
                const userBadge = document.getElementById('userBadge');
                const userName = document.getElementById('userName');
                
                if (userBadge) {
                    if (isAdmin()) userBadge.textContent = 'ADMIN';
                    else if (isOperator()) userBadge.textContent = 'OPERADOR';
                    else if (isCollaborator()) userBadge.textContent = 'COLABORADOR';
                }
                
                if (userName) {
                    userName.textContent = currentUser.name;
                }
            }

            checkUrlForItem();
        }

        function checkSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showDashboard();
                    setTimeout(() => initializeSystem(), 500);
                } catch (e) {
                    console.error('Erro na sess√£o:', e);
                }
            }
        }

        // ============================================
        // FUN√á√ïES DO MENU
        // ============================================
        function openMenu() {
            document.getElementById('mobileSidebar').classList.add('open');
            document.getElementById('menuOverlay').style.display = 'block';

            if (currentUser) {
                document.getElementById('menuUserName').textContent = currentUser.name;
                document.getElementById('menuUserEmail').textContent = currentUser.email;
                document.getElementById('menuUserRole').textContent =
                    isAdmin() ? 'ADMIN' :
                    isOperator() ? 'OPERADOR' :
                    isCollaborator() ? 'COLABORADOR' : 'USU√ÅRIO';
            }
        }

        function closeMenu() {
            document.getElementById('mobileSidebar').classList.remove('open');
            document.getElementById('menuOverlay').style.display = 'none';
        }

        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                if (scannerActive) {
                    stopScanner();
                }

                localStorage.removeItem('currentUser');
                currentUser = null;

                closeMenu();

                document.getElementById('mobileDashboard').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';

                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';

                showNotification('Logout realizado com sucesso', 'success');
            }
        }

        function switchTab(tab) {
            currentTab = tab;

            if (scannerActive && tab !== 'scanner') {
                stopScanner();
            }

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
            });

            document.querySelectorAll('.tab-content').forEach(div => {
                div.style.display = 'none';
            });

            switch (tab) {
                case 'dashboard':
                    document.getElementById('tabDashboard').style.display = 'block';
                    updateUI();
                    break;
                case 'cadastro':
                    if (isAdmin()) {
                        document.getElementById('tabCadastro').style.display = 'block';
                        loadCadastroForm();
                    } else {
                        switchTab('dashboard');
                    }
                    break;
                case 'catalogo':
                    if (isAdmin() || isOperator()) {
                        document.getElementById('tabCatalogo').style.display = 'block';
                        loadedToolsCount = 50;
                        updateToolsList();
                    } else {
                        switchTab('dashboard');
                    }
                    break;
                case 'scanner':
                    document.getElementById('tabScanner').style.display = 'block';
                    break;
                case 'assignments':
                    document.getElementById('tabAssignments').style.display = 'block';
                    showAssignmentsList(true);
                    break;
                case 'config':
                    document.getElementById('tabConfig').style.display = 'block';
                    document.getElementById('localItemsCount').textContent = tools.length;
                    document.getElementById('localAssignmentsCount').textContent = assignments.length;
                    document.getElementById('lastSyncTime').textContent = localStorage.getItem('lastSync') ? 
                        new Date(localStorage.getItem('lastSync')).toLocaleString() : 'Nunca';
                    break;
            }
        }

        // ============================================
        // FUN√á√ïES AUXILIARES
        // ============================================
        function getStatusColor(status) {
            switch (status) {
                case 'Dispon√≠vel':
                case 'Disponivel':
                    return '#27ae60';
                case 'Em Uso':
                    return '#3498db';
                case 'Manuten√ß√£o':
                    return '#f39c12';
                case 'Danificado':
                    return '#e74c3c';
                default:
                    return '#95a5a6';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const content = document.getElementById('notificationContent');

            if (notification && content) {
                content.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
                notification.className = `notification ${type} show`;

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        function showLoader(show) {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.display = show ? 'block' : 'none';
            }
        }

        function showUserProfile() {
            let permissions = '';
            if (isAdmin()) permissions = '‚úÖ Admin - Acesso total';
            else if (isOperator()) permissions = 'üëÅÔ∏è Operador - Visualiza√ß√£o';
            else if (isCollaborator()) permissions = 'üîß Colaborador - Auto-atribui√ß√£o';
            
            alert(`Perfil do Usu√°rio:\n\nNome: ${currentUser.name}\nEmail: ${currentUser.email}\nFun√ß√£o: ${currentUser.role}\n${permissions}`);
            closeMenu();
        }

        function showAbout() {
            closeMenu();
            alert('Sistema de Ferramentas Mobile v3\n\nDesenvolvido por F√°bio Mendes Rodrigues.\n\n¬© 2026 FW Company');
        }

        function showHelp() {
            closeMenu();
            alert('Ajuda do Sistema:\n\n1. Dashboard: Vis√£o geral\n2. Scanner: Ler QR Codes\n3. Atribui√ß√µes: Gerenciar ferramentas\n\nUse o menu para mais op√ß√µes.');
        }

        function manageUsers() {
            closeMenu();
            showNotification('Gerenciamento de usu√°rios em desenvolvimento', 'info');
        }

        function showReports() {
            closeMenu();
            showNotification('Relat√≥rios em desenvolvimento', 'info');
        }

        function backupData() {
            closeMenu();
            showNotification('Backup em desenvolvimento', 'info');
        }

        // ============================================
        // FUN√á√ïES DE CONEX√ÉO SUPABASE
        // ============================================
        async function connectToSupabase() {
            try {
                supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);

                const { data, error } = await supabaseClient
                    .from('tools')
                    .select('count')
                    .limit(1);

                if (error) throw error;

                updateConnectionStatus(true);
                return true;

            } catch (error) {
                console.error('‚ùå Erro ao conectar:', error);
                updateConnectionStatus(false);
                return false;
            }
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const syncElement = document.getElementById('syncStatus');

            if (connected) {
                statusElement.textContent = 'Online';
                statusElement.style.background = 'rgba(39,174,96,0.2)';
                statusElement.style.color = '#27ae60';
                syncElement.textContent = 'Cloud';
            } else {
                statusElement.textContent = 'Offline';
                statusElement.style.background = 'rgba(231,76,60,0.2)';
                statusElement.style.color = '#e74c3c';
                syncElement.textContent = 'Local';
            }
        }

        // ============================================
        // FUN√á√ïES DE CARREGAMENTO DE COLABORADORES
        // ============================================
        async function loadCollaborators() {
            try {
                if (!supabaseClient) {
                    console.log('‚ö†Ô∏è Sem conex√£o com Supabase');
                    return [];
                }

                const { data, error } = await supabaseClient
                    .from('collaborators')
                    .select('*')
                    .eq('status', 'active')
                    .order('name');

                if (error) throw error;

                collaborators = data || [];
                console.log(`‚úÖ ${collaborators.length} colaboradores carregados`);
                return collaborators;
            } catch (error) {
                console.error('‚ùå Erro ao carregar colaboradores:', error);
                return [];
            }
        }

        // ============================================
        // FUN√á√ïES DE ATRIBUI√á√ÉO
        // ============================================
        async function loadAssignments() {
            try {
                if (!supabaseClient) {
                    console.log('‚ö†Ô∏è Sem conex√£o com Supabase');
                    return [];
                }

                const { data, error } = await supabaseClient
                    .from('tool_assignments')
                    .select('*')
                    .order('assignment_date', { ascending: false });

                if (error) throw error;

                assignments = data || [];
                console.log(`‚úÖ ${assignments.length} atribui√ß√µes carregadas`);
                
                // Atualizar contador de atribui√ß√µes ativas
                const activeCount = assignments.filter(a => a.status === 'active').length;
                document.getElementById('assignedCount').textContent = activeCount;
                document.getElementById('localAssignmentsCount').textContent = assignments.length;
                
                return assignments;
            } catch (error) {
                console.error('‚ùå Erro ao carregar atribui√ß√µes:', error);
                return [];
            }
        }

        async function assignTool(toolId, collaboratorId) {
            try {
                // Verificar permiss√£o
                if (!isAdmin()) {
                    showNotification('Voc√™ n√£o tem permiss√£o para atribuir ferramentas', 'error');
                    return false;
                }

                // Buscar ferramenta
                const tool = tools.find(t => t.id == toolId);
                if (!tool) {
                    showNotification('Ferramenta n√£o encontrada', 'error');
                    return false;
                }

                // Verificar se ferramenta j√° est√° atribu√≠da
                const activeAssignment = assignments.find(a => a.tool_id == toolId && a.status === 'active');
                if (activeAssignment) {
                    showNotification('Esta ferramenta j√° est√° atribu√≠da a algu√©m', 'error');
                    return false;
                }

                // Buscar colaborador
                const collaborator = collaborators.find(c => c.id == collaboratorId);
                if (!collaborator) {
                    showNotification('Colaborador n√£o encontrado', 'error');
                    return false;
                }

                // Criar nova atribui√ß√£o
                const newAssignment = {
                    id: Date.now().toString(),
                    tool_id: tool.id.toString(),
                    tool_code: tool.code,
                    tool_name: tool.name,
                    collaborator_id: collaborator.id.toString(),
                    collaborator_registration: collaborator.registration,
                    collaborator_name: collaborator.name,
                    assignment_date: new Date().toISOString().split('T')[0],
                    assignment_type: 'collaborator',
                    assigned_to_type: 'colaborador',
                    assigned_to_id: collaborator.id.toString(),
                    assigned_to_name: collaborator.name,
                    status: 'active',
                    observations: null,
                    user_assigned: currentUser.name,
                    user_returned: null,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    returned_date: null,
                    expected_return_date: null,
                    actual_return_date: null,
                    local_id: Date.now().toString(),
                    sync_status: isOnline ? 'synced' : 'pending',
                    source: null
                };

                // Salvar no Supabase se estiver online
                if (isOnline && supabaseClient) {
                    try {
                        const { error } = await supabaseClient
                            .from('tool_assignments')
                            .insert([newAssignment]);

                        if (error) throw error;
                    } catch (error) {
                        console.error('Erro ao salvar atribui√ß√£o no Supabase:', error);
                        newAssignment.sync_status = 'pending';
                    }
                } else {
                    newAssignment.sync_status = 'pending';
                }

                // Adicionar √† lista local
                assignments.unshift(newAssignment);

                // Atualizar status da ferramenta
                tool.status = 'Em Uso';
                await updateToolStatus(tool.id, 'Em Uso');

                showNotification(`Ferramenta atribu√≠da a ${collaborator.name}`, 'success');
                
                // Atualizar interface
                updateUI();
                
                return true;
            } catch (error) {
                console.error('Erro ao atribuir ferramenta:', error);
                showNotification('Erro ao atribuir ferramenta', 'error');
                return false;
            }
        }

        async function returnTool(assignmentId) {
            try {
                // Verificar permiss√£o
                if (!isAdmin()) {
                    showNotification('Voc√™ n√£o tem permiss√£o para devolver ferramentas', 'error');
                    return false;
                }

                const assignment = assignments.find(a => a.id == assignmentId);
                if (!assignment) {
                    showNotification('Atribui√ß√£o n√£o encontrada', 'error');
                    return false;
                }

                // Atualizar atribui√ß√£o
                assignment.status = 'returned';
                assignment.user_returned = currentUser.name;
                assignment.actual_return_date = new Date().toISOString().split('T')[0];
                assignment.updated_at = new Date().toISOString();
                assignment.sync_status = isOnline ? 'synced' : 'pending';

                // Atualizar no Supabase se estiver online
                if (isOnline && supabaseClient) {
                    try {
                        const { error } = await supabaseClient
                            .from('tool_assignments')
                            .update({
                                status: 'returned',
                                user_returned: currentUser.name,
                                actual_return_date: assignment.actual_return_date,
                                updated_at: assignment.updated_at
                            })
                            .eq('id', assignment.id);

                        if (error) throw error;
                    } catch (error) {
                        console.error('Erro ao atualizar atribui√ß√£o no Supabase:', error);
                        assignment.sync_status = 'pending';
                    }
                }

                // Atualizar status da ferramenta
                await updateToolStatus(assignment.tool_id, 'Dispon√≠vel');

                showNotification('Ferramenta devolvida com sucesso', 'success');
                
                // Atualizar interface
                updateUI();
                
                return true;
            } catch (error) {
                console.error('Erro ao devolver ferramenta:', error);
                showNotification('Erro ao devolver ferramenta', 'error');
                return false;
            }
        }

        async function updateToolStatus(toolId, newStatus) {
            try {
                const tool = tools.find(t => t.id == toolId);
                if (tool) {
                    tool.status = newStatus;
                    tool.updatedAt = new Date().toISOString();
                    
                    // Salvar no IndexedDB
                    await saveToIndexedDB(tools);
                    
                    // Atualizar no Supabase se estiver online
                    if (isOnline && supabaseClient) {
                        await supabaseClient
                            .from('tools')
                            .update({ 
                                status: newStatus,
                                updated_at: tool.updatedAt
                            })
                            .eq('id', toolId);
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar status da ferramenta:', error);
            }
        }

        // ============================================
        // FUN√á√ïES DO SCANNER QR CODE
        // ============================================
        async function startScanner() {
            try {
                showNotification('Iniciando scanner...', 'info');

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showNotification('C√¢mera n√£o dispon√≠vel neste dispositivo', 'error');
                    return;
                }

                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                const video = document.createElement('video');
                video.id = 'scanner-video';
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                video.setAttribute('playsinline', 'true');
                video.setAttribute('autoplay', 'true');
                video.setAttribute('muted', 'true');

                const overlay = document.createElement('div');
                overlay.className = 'scanner-overlay';
                overlay.innerHTML = `
                    <div class="scanner-frame">
                        <div class="scanner-line"></div>
                    </div>
                `;

                const container = document.getElementById('scannerContainer');
                container.innerHTML = '';
                container.appendChild(video);
                container.appendChild(overlay);

                video.srcObject = videoStream;

                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play()
                            .then(resolve)
                            .catch(reject);
                    };
                });

                document.getElementById('startScannerBtn').style.display = 'none';
                document.getElementById('stopScannerBtn').style.display = 'block';
                document.getElementById('scannerResult').style.display = 'none';

                scannerActive = true;
                startScanningLoop(video);
                showNotification('Scanner ativo. Aponte para um QR Code.', 'success');

            } catch (error) {
                console.error('Erro ao iniciar scanner:', error);

                if (error.name === 'NotAllowedError') {
                    showNotification('Permiss√£o da c√¢mera negada', 'error');
                } else if (error.name === 'NotFoundError') {
                    showNotification('C√¢mera n√£o encontrada', 'error');
                } else {
                    showNotification(`Erro: ${error.message}`, 'error');
                }

                resetScannerUI();
            }
        }

        function startScanningLoop(video) {
            const canvas = document.getElementById('qr-canvas');
            const context = canvas.getContext('2d');

            if (scanningInterval) {
                clearInterval(scanningInterval);
            }

            scanningInterval = setInterval(() => {
                if (!scannerActive || !video.readyState === video.HAVE_ENOUGH_DATA) {
                    return;
                }

                if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                }

                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

                try {
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });

                    if (code) {
                        handleQRCodeDetected(code.data);
                    }
                } catch (error) {
                    console.log('Erro na leitura do QR Code:', error);
                }
            }, 250);
        }

        function stopScanner() {
            scannerActive = false;

            if (scanningInterval) {
                clearInterval(scanningInterval);
                scanningInterval = null;
            }

            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            resetScannerUI();
        }

        function resetScannerUI() {
            const container = document.getElementById('scannerContainer');
            container.innerHTML = `
                <i class="fas fa-qrcode" style="font-size: 60px; color: var(--gray-color); margin-bottom: 15px;"></i>
                <p style="text-align: center; color: var(--gray-color);">√Årea do scanner</p>
                <p style="text-align: center; font-size: 12px; color: var(--gray-color); margin-top: 10px;">
                    Toque para ativar a c√¢mera
                </p>
            `;

            document.getElementById('startScannerBtn').style.display = 'block';
            document.getElementById('stopScannerBtn').style.display = 'none';
            document.getElementById('scannerResult').style.display = 'none';
        }

        function showTextQRCode(data) {
            document.getElementById('scannerResult').style.display = 'block';
            document.getElementById('scannedData').innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong style="color: var(--warning-color);">‚ö† Texto Detectado</strong>
                </div>
                <p><strong>Conte√∫do:</strong></p>
                <div style="background: white; padding: 10px; border-radius: 5px; word-break: break-all;">
                    ${data}
                </div>
            `;
            
            document.getElementById('viewScannedItemBtn').style.display = 'none';
            document.getElementById('assignScannedItemBtn').style.display = 'none';
            document.getElementById('collabTakeItemBtn').style.display = 'none';
        }

        // ============================================
        // FUN√á√ïES DE BUSCA DE ITENS
        // ============================================
        function buscarItemLocal(itemId) {
            return new Promise((resolve) => {
                const idToFind = isNaN(itemId) ? itemId : Number(itemId);

                let tool = tools.find(t => t.id == idToFind);

                if (tool) {
                    console.log('Item encontrado na mem√≥ria');
                    resolve(tool);
                    return;
                }

                if (db) {
                    const transaction = db.transaction(['tools'], 'readonly');
                    const store = transaction.objectStore('tools');
                    const request = store.get(idToFind);

                    request.onsuccess = () => {
                        if (request.result) {
                            console.log('Item encontrado no IndexedDB');
                            tools.push(request.result);
                            resolve(request.result);
                        } else {
                            console.log('Item n√£o encontrado no IndexedDB');
                            resolve(null);
                        }
                    };

                    request.onerror = () => {
                        console.error('Erro ao buscar no IndexedDB');
                        resolve(null);
                    };
                } else {
                    resolve(null);
                }
            });
        }

        async function buscarItemNoSupabase(itemId, dadosAdicionais = null, callback = null) {
            if (!supabaseClient) {
                showNotification('Sem conex√£o com o Supabase', 'error');
                return;
            }

            showLoader(true);

            try {
                console.log('üîç Buscando item no Supabase. ID:', itemId);

                let query = supabaseClient.from('tools').select('*');

                if (!isNaN(itemId)) {
                    query = query.eq('id', Number(itemId));
                } else {
                    query = query.eq('code', itemId);
                }

                const { data, error } = await query.maybeSingle();

                if (error) {
                    console.error('Erro na consulta:', error);
                    throw error;
                }

                if (data) {
                    const tool = await processarItemDoSupabase(data);
                    if (callback) callback(tool);
                } else {
                    showNotification('Item n√£o encontrado no Supabase', 'error');
                }

            } catch (error) {
                console.error('‚ùå Erro ao buscar no Supabase:', error);
                showNotification(`Erro: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }

        async function processarItemDoSupabase(item) {
            try {
                console.log('‚úÖ Item encontrado no Supabase:', item);

                const tool = {
                    id: item.id,
                    name: item.name,
                    code: item.code,
                    patrimonio: item.patrimonio,
                    ncm: item.ncm,
                    category: item.category,
                    status: item.status,
                    location: item.location,
                    condition: item.condition,
                    notaFiscal: item.nota_fiscal,
                    unidade: item.unidade,
                    preco: item.preco,
                    quantidade: item.quantidade,
                    estoqueMinimo: item.estoque_minimo,
                    estoqueMaximo: item.estoque_maximo,
                    description: item.description,
                    observations: item.observations,
                    image: item.image_url,
                    usuarioCadastro: item.usuario_cadastro,
                    dataCadastro: item.data_cadastro,
                    createdAt: item.created_at,
                    updatedAt: item.updated_at,
                    qrCode: item.qr_code
                };

                // Verificar se j√° existe
                const existingIndex = tools.findIndex(t => t.id == tool.id);
                if (existingIndex >= 0) {
                    tools[existingIndex] = tool;
                } else {
                    tools.push(tool);
                }

                await saveToIndexedDB(tools);

                return tool;
            } catch (error) {
                console.error('Erro ao processar item do Supabase:', error);
                return null;
            }
        }

        // ============================================
        // FUN√á√ïES DE SINCRONIZA√á√ÉO
        // ============================================
        async function fetchAllFromSupabase() {
            try {
                if (!supabaseClient) {
                    showNotification('N√£o conectado √† nuvem', 'warning');
                    return { success: false, count: 0, total: 0 };
                }

                showLoader(true);
                showNotification('Buscando todos os itens...', 'warning');

                const { count, error: countError } = await supabaseClient
                    .from('tools')
                    .select('*', { count: 'exact', head: true });

                if (countError) throw countError;

                totalToolsInDB = count || 0;
                console.log(`üìä Total de itens no banco: ${totalToolsInDB}`);

                if (totalToolsInDB === 0) {
                    showNotification('Nenhum item encontrado', 'warning');
                    return { success: false, count: 0, total: 0 };
                }

                const BATCH_SIZE = 1000;
                let allTools = [];
                let currentPage = 0;

                while (allTools.length < totalToolsInDB) {
                    const { data, error } = await supabaseClient
                        .from('tools')
                        .select('*')
                        .range(currentPage * BATCH_SIZE, (currentPage * BATCH_SIZE) + BATCH_SIZE - 1)
                        .order('id', { ascending: true });

                    if (error) throw error;

                    if (data && data.length > 0) {
                        allTools = [...allTools, ...data];
                        console.log(`üì¶ P√°gina ${currentPage + 1}: ${data.length} itens`);

                        const progress = Math.round((allTools.length / totalToolsInDB) * 100);
                        showNotification(`Progresso: ${progress}%`, 'info');

                        currentPage++;

                        if (allTools.length < totalToolsInDB) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    } else {
                        break;
                    }
                }

                console.log(`‚úÖ Total recebido: ${allTools.length} itens`);

                const convertedTools = allTools.map(item => ({
                    id: item.id,
                    name: item.name,
                    code: item.code,
                    patrimonio: item.patrimonio,
                    ncm: item.ncm,
                    category: item.category,
                    status: item.status,
                    location: item.location,
                    condition: item.condition,
                    notaFiscal: item.nota_fiscal,
                    unidade: item.unidade,
                    preco: item.preco,
                    quantidade: item.quantidade,
                    estoqueMinimo: item.estoque_minimo,
                    estoqueMaximo: item.estoque_maximo,
                    description: item.description,
                    observations: item.observations,
                    image: item.image_url,
                    usuarioCadastro: item.usuario_cadastro,
                    dataCadastro: item.data_cadastro,
                    createdAt: item.created_at,
                    updatedAt: item.updated_at,
                    qrCode: item.qr_code
                }));

                await saveToIndexedDB(convertedTools);
                tools = await loadFromIndexedDB(999999);

                // Carregar colaboradores e atribui√ß√µes
                await loadCollaborators();
                await loadAssignments();

                updateUI();

                localStorage.setItem('lastSync', new Date().toISOString());
                localStorage.setItem('totalItems', totalToolsInDB.toString());

                showNotification(`‚úÖ ${allTools.length} itens sincronizados!`, 'success');
                updateSyncInfo();

                return {
                    success: true,
                    count: allTools.length,
                    total: totalToolsInDB
                };

            } catch (error) {
                console.error('‚ùå Erro ao sincronizar:', error);
                showNotification(`Erro: ${error.message}`, 'error');
                return { success: false, count: 0, total: 0 };
            } finally {
                showLoader(false);
            }
        }

        // ============================================
        // FUN√á√ïES INDEXEDDB
        // ============================================
        const DB_NAME = 'FerramentasDB';
        const DB_VERSION = 2;
        const STORE_NAME = 'tools';

        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    reject('IndexedDB n√£o suportado');
                    return;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('‚ùå Erro ao abrir IndexedDB:', event.target.error);
                    reject(event.target.error);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('‚úÖ IndexedDB inicializado');
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    const oldVersion = event.oldVersion;

                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, {
                            keyPath: 'id'
                        });

                        store.createIndex('code', 'code', { unique: true });
                        store.createIndex('category', 'category', { unique: false });
                        store.createIndex('status', 'status', { unique: false });
                        store.createIndex('updatedAt', 'updatedAt', { unique: false });
                    }

                    console.log(`üîÑ IndexedDB atualizado da vers√£o ${oldVersion} para ${DB_VERSION}`);
                };
            });
        }

        async function saveToIndexedDB(data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('IndexedDB n√£o inicializado');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                const clearRequest = store.clear();

                clearRequest.onsuccess = () => {
                    let successCount = 0;

                    const insertNext = (index) => {
                        if (index >= data.length) {
                            console.log(`‚úÖ ${successCount} itens salvos`);
                            resolve(successCount);
                            return;
                        }

                        const item = data[index];
                        const request = store.add(item);

                        request.onsuccess = () => {
                            successCount++;
                            insertNext(index + 1);
                        };

                        request.onerror = () => {
                            console.error(`‚ùå Erro ao salvar item ${index}`);
                            insertNext(index + 1);
                        };
                    };

                    insertNext(0);
                };
            });
        }

        function loadFromIndexedDB(limit = 999999) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('IndexedDB n√£o inicializado');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const index = store.index('updatedAt');

                const request = index.openCursor(null, 'prev');
                const results = [];
                let count = 0;

                request.onsuccess = (event) => {
                    const cursor = event.target.result;

                    if (cursor && count < limit) {
                        results.push(cursor.value);
                        count++;
                        cursor.continue();
                    } else {
                        resolve(results);
                    }
                };
            });
        }

        function searchInIndexedDB(searchTerm) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('IndexedDB n√£o inicializado');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.openCursor();
                const results = [];
                const term = searchTerm.toLowerCase();

                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const tool = cursor.value;
                        if ((tool.name && tool.name.toLowerCase().includes(term)) ||
                            (tool.code && tool.code.toLowerCase().includes(term)) ||
                            (tool.patrimonio && tool.patrimonio.toLowerCase().includes(term)) ||
                            (tool.category && tool.category.toLowerCase().includes(term)) ||
                            (tool.location && tool.location.toLowerCase().includes(term)) ||
                            (tool.description && tool.description.toLowerCase().includes(term))) {
                            results.push(tool);
                        }
                        cursor.continue();
                    } else {
                        resolve(results);
                    }
                };
            });
        }

        // ============================================
        // FUN√á√ïES DE CAT√ÅLOGO E LISTAGEM
        // ============================================
        async function updateToolsList() {
            const listElement = document.getElementById('toolsList');
            const searchInput = document.getElementById('searchInput');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            let displayTools = [];

            if (searchTerm) {
                showLoader(true);

                try {
                    displayTools = await searchInIndexedDB(searchTerm);

                    document.getElementById('toolsCount').textContent =
                        `${displayTools.length} de ${localStorage.getItem('totalItems') || tools.length} itens encontrados`;

                    if (displayTools.length === 0) {
                        listElement.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 40px;">Nenhum item encontrado para "' + searchTerm + '"</p>';
                        showLoader(false);
                        return;
                    }

                } catch (error) {
                    console.error('Erro na busca:', error);
                    showNotification('Erro ao buscar itens', 'error');
                    displayTools = [];
                } finally {
                    showLoader(false);
                }

                if (loadMoreBtn) {
                    loadMoreBtn.style.display = 'none';
                }

            } else {
                displayTools = tools;

                if (loadMoreBtn) {
                    loadMoreBtn.style.display = 'none';
                }

                if (displayTools.length === 0) {
                    listElement.innerHTML = '<p style="text-align: center; color: var(--gray-color); padding: 40px;">Nenhum item cadastrado</p>';
                    return;
                }

                document.getElementById('toolsCount').textContent =
                    `${displayTools.length} de ${displayTools.length} itens carregados`;
            }

            renderToolList(displayTools);
        }

        function renderToolList(toolsToRender) {
            const listElement = document.getElementById('toolsList');
            const restricted = !isAdmin() && !isOperator();

            let html = '';
            toolsToRender.forEach(tool => {
                const thumbnailHTML = tool.image ?
                    `<img src="${tool.image}" alt="${tool.name}" onerror="this.parentElement.innerHTML='<i class=\'fas fa-tools\'></i>'">` :
                    `<i class="fas fa-tools"></i>`;

                // Verificar se est√° atribu√≠do
                const activeAssignment = assignments.find(a => a.tool_id == tool.id && a.status === 'active');
                const isAvailable = tool.status === 'Dispon√≠vel' || tool.status === 'Disponivel';

                html += `
                    <div class="card" style="margin-bottom: 10px; padding: 15px;" data-id="${tool.id}">
                        <div style="display: flex; align-items: start; margin-bottom: 10px;">
                            <div class="thumbnail" style="margin-right: 12px; flex-shrink: 0;">
                                ${thumbnailHTML}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; font-size: 16px;">${tool.name}</div>
                                <div style="font-size: 14px; color: var(--gray-color);">${tool.code}${tool.patrimonio ? ' | ' + tool.patrimonio : ''}</div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px; flex-wrap: wrap;">
                                    <span style="font-size: 12px; padding: 3px 8px; background: ${getStatusColor(tool.status)}20; color: ${getStatusColor(tool.status)}; border-radius: 12px;">
                                        ${tool.status}
                                    </span>
                                    <span style="font-size: 12px; color: var(--gray-color);">${tool.location}</span>
                                    <span style="font-size: 12px; color: var(--gray-color);">Qtd: ${tool.quantidade || 1}</span>
                                </div>
                                ${activeAssignment ? 
                                    `<div style="font-size: 12px; margin-top: 5px; color: var(--assign-color);">
                                        <i class="fas fa-hand-holding"></i> ${activeAssignment.collaborator_name}
                                    </div>` : 
                                    ''}
                            </div>
                        </div>
                        
                        <div class="tool-actions">
                            <button class="action-btn view" data-id="${tool.id}">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            ${!restricted ? 
                                `<button class="action-btn qr" data-id="${tool.id}">
                                    <i class="fas fa-qrcode"></i> QR
                                </button>` : 
                                ''}
                            ${isAdmin() && isAvailable && !activeAssignment ? 
                                `<button class="action-btn assign" data-id="${tool.id}">
                                    <i class="fas fa-hand-holding"></i> Atribuir
                                </button>` : 
                                ''}
                            ${isCollaborator() && isAvailable && !activeAssignment ? 
                                `<button class="action-btn collab-assign" data-id="${tool.id}">
                                    <i class="fas fa-hand-holding-heart"></i> Pegar
                                </button>` : 
                                ''}
                        </div>
                    </div>
                `;
            });

            listElement.innerHTML = html;

            document.querySelectorAll('.action-btn.view').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const toolId = this.getAttribute('data-id');
                    showToolDetails(toolId);
                });
            });

            document.querySelectorAll('.action-btn.qr').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const toolId = this.getAttribute('data-id');
                    generateQRCode(toolId);
                });
            });

            document.querySelectorAll('.action-btn.assign').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const toolId = this.getAttribute('data-id');
                    const tool = tools.find(t => t.id == toolId);
                    if (tool) {
                        showAssignModal(tool);
                    }
                });
            });

            document.querySelectorAll('.action-btn.collab-assign').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const toolId = this.getAttribute('data-id');
                    takeToolAsCollaborator(toolId);
                });
            });

            document.querySelectorAll('.card[data-id]').forEach(card => {
                card.addEventListener('click', function (e) {
                    if (!e.target.closest('.action-btn')) {
                        const toolId = this.getAttribute('data-id');
                        showToolDetails(toolId);
                    }
                });
            });
        }

        // ============================================
        // FUN√á√ïES DE MODAIS
        // ============================================
        function setupModalEvents() {
            const closeModalBtn = document.getElementById('closeModalBtn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeItemModal);
            }

            const closeQRModalBtn = document.getElementById('closeQRModalBtn');
            if (closeQRModalBtn) {
                closeQRModalBtn.addEventListener('click', closeQRModal);
            }

            const closeAssignModalBtn = document.getElementById('closeAssignModalBtn');
            if (closeAssignModalBtn) {
                closeAssignModalBtn.addEventListener('click', closeAssignModal);
            }

            const itemModal = document.getElementById('itemModal');
            const qrModal = document.getElementById('qrModal');
            const assignModal = document.getElementById('assignModal');

            if (itemModal) {
                itemModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        closeItemModal();
                    }
                });
            }

            if (qrModal) {
                qrModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        closeQRModal();
                    }
                });
            }

            if (assignModal) {
                assignModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        closeAssignModal();
                    }
                });
            }
        }

        function closeItemModal() {
            document.getElementById('itemModal').style.display = 'none';
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        function closeAssignModal() {
            document.getElementById('assignModal').style.display = 'none';
            assignmentInProgress = null;
        }

        // ============================================
        // FUN√á√ïES DE DETALHES DO ITEM
        // ============================================
        function showToolDetails(toolId) {
            const tool = tools.find(t => t.id == toolId);
            if (!tool) return;

            const imageHTML = tool.image ?
                `<div class="image-preview">
                    <img src="${tool.image}" alt="${tool.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-tools\' style=\'font-size:60px; color:#ccc;\'></i><p>Sem imagem</p>'">
                </div>` :
                `<div class="image-preview">
                    <i class="fas fa-tools" style="font-size: 60px; color: #ccc;"></i>
                    <p style="margin-top: 10px; color: var(--gray-color);">Sem imagem</p>
                </div>`;

            // Verificar atribui√ß√£o atual
            const activeAssignment = assignments.find(a => a.tool_id == tool.id && a.status === 'active');
            const isMine = isCollaborator() && activeAssignment && activeAssignment.collaborator_id == currentUser.collaboratorId;
            
            let assignmentInfo = '';
            if (activeAssignment) {
                if (isMine) {
                    assignmentInfo = `
                        <div style="margin-top: 15px; background: var(--collab-color); padding: 15px; border-radius: 8px; color: white;">
                            <h4 style="margin-bottom: 10px;"><i class="fas fa-hand-holding-heart"></i> Esta ferramenta est√° com voc√™!</h4>
                            <p>Atribu√≠da em: ${formatDate(activeAssignment.assignment_date)}</p>
                            <button class="mobile-btn" onclick="returnMyTool('${activeAssignment.id}')" style="margin-top: 10px; background: white; color: var(--collab-color);">
                                <i class="fas fa-undo-alt"></i> Devolver Ferramenta
                            </button>
                        </div>
                    `;
                } else if (isAdmin()) {
                    assignmentInfo = `
                        <div style="margin-top: 15px; background: #8e44ad20; padding: 15px; border-radius: 8px; border-left: 4px solid var(--assign-color);">
                            <h4 style="margin-bottom: 10px; color: var(--assign-color);"><i class="fas fa-hand-holding"></i> Atribui√ß√£o Ativa</h4>
                            <p><strong>Colaborador:</strong> ${activeAssignment.collaborator_name}</p>
                            <p><strong>Data:</strong> ${formatDate(activeAssignment.assignment_date)}</p>
                            <button class="mobile-btn" onclick="returnTool('${activeAssignment.id}')" style="margin-top: 10px; background: var(--success-color); color: white;">
                                <i class="fas fa-undo-alt"></i> Registrar Devolu√ß√£o
                            </button>
                        </div>
                    `;
                } else {
                    assignmentInfo = `
                        <div style="margin-top: 15px; background: var(--light-color); padding: 15px; border-radius: 8px;">
                            <p><i class="fas fa-info-circle"></i> Esta ferramenta est√° em uso por ${activeAssignment.collaborator_name}</p>
                        </div>
                    `;
                }
            }

            document.getElementById('modalTitle').textContent = tool.name;

            let detailsHtml = `
                ${imageHTML}
                ${assignmentInfo}
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                    <div><strong>C√≥digo:</strong><br>${tool.code}</div>
                    <div><strong>Patrim√¥nio:</strong><br>${tool.patrimonio || 'N√£o informado'}</div>
                    <div><strong>Categoria:</strong><br>${tool.category}</div>
                    <div><strong>Status:</strong><br><span style="color: ${getStatusColor(tool.status)}">${tool.status}</span></div>
                    <div><strong>Localiza√ß√£o:</strong><br>${tool.location}</div>
                    <div><strong>Quantidade:</strong><br>${tool.quantidade || 1}</div>
            `;

            // Adicionar pre√ßo apenas para admins e operadores
            if (isAdmin() || isOperator()) {
                detailsHtml += `
                    <div><strong>Pre√ßo:</strong><br>R$ ${parseFloat(tool.preco || 0).toFixed(2).replace('.', ',')}</div>
                `;
            }

            detailsHtml += `
                </div>
            `;

            if (tool.description && (isAdmin() || isOperator())) {
                detailsHtml += `
                    <div style="margin-top: 15px;">
                        <strong>Descri√ß√£o:</strong>
                        <p style="margin-top: 5px; background: var(--light-color); padding: 10px; border-radius: 8px;">${tool.description}</p>
                    </div>
                `;
            }

            detailsHtml += `
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <button id="modalCloseBtn" class="mobile-btn" style="background: var(--gray-color); color: white;">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = detailsHtml;
            document.getElementById('itemModal').style.display = 'flex';

            document.getElementById('modalCloseBtn').addEventListener('click', closeItemModal);
        }

        // ============================================
        // FUN√á√ïES DE QR CODE
        // ============================================
        function generateQRCode(toolId) {
            console.log('Gerando QR Code para:', toolId);

            const tool = tools.find(t => t.id == toolId);
            if (!tool) {
                console.error('Ferramenta n√£o encontrada:', toolId);
                showNotification('Erro: Item n√£o encontrado', 'error');
                return;
            }

            const baseUrl = window.location.origin + window.location.pathname;
            const linkUrl = `${baseUrl}?item=${tool.id}`;

            console.log('Link gerado:', linkUrl);

            const qrModalBody = document.getElementById('qrModalBody');
            qrModalBody.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>${tool.name}</h4>
                    <p style="color: var(--gray-color); font-size: 14px;">${tool.code}</p>
                </div>
                <div id="qrcodeContainer" style="margin: 20px auto; text-align: center;"></div>
                <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                    <button id="downloadQRBtn" class="mobile-btn" style="background: var(--secondary-color); color: white;">
                        <i class="fas fa-download"></i> Baixar QR Code
                    </button>
                    <button id="closeQRBtn" class="mobile-btn" style="background: var(--gray-color); color: white;">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
                <p style="font-size: 10px; color: var(--gray-color); margin-top: 10px; word-break: break-all;">
                    Link: ${linkUrl}
                </p>
            `;

            document.getElementById('qrModal').style.display = 'flex';

            setTimeout(() => {
                try {
                    const container = document.getElementById('qrcodeContainer');
                    container.innerHTML = '';

                    new QRCode(container, {
                        text: linkUrl,
                        width: 200,
                        height: 200,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.L
                    });

                    console.log('QR Code gerado com sucesso!');

                    document.getElementById('downloadQRBtn').addEventListener('click', function () {
                        const canvas = container.querySelector('canvas');
                        if (canvas) {
                            const link = document.createElement('a');
                            link.download = `QRCode_${tool.code}.png`;
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                            showNotification('QR Code baixado!', 'success');
                        }
                    });

                    document.getElementById('closeQRBtn').addEventListener('click', closeQRModal);

                } catch (error) {
                    console.error('Erro ao gerar QR Code:', error);
                    document.getElementById('qrcodeContainer').innerHTML =
                        '<p style="color: var(--danger-color);">Erro ao gerar QR Code</p>';
                }
            }, 100);
        }

        // ============================================
        // FUN√á√ïES DE FORMUL√ÅRIO DE CADASTRO
        // ============================================
        function loadCadastroForm() {
            if (!isAdmin()) return;

            document.getElementById('cadastroForm').innerHTML = `
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Cadastrar Novo Item</h3>
                    
                    <div class="form-group">
                        <label for="cadastroNome">Nome do Produto *</label>
                        <input type="text" id="cadastroNome" placeholder="Ex: Martelo de Borracha">
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroCodigo">C√≥digo *</label>
                        <input type="text" id="cadastroCodigo" placeholder="Ex: MART-001">
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroPatrimonio">Patrim√¥nio</label>
                        <input type="text" id="cadastroPatrimonio" placeholder="N¬∫ de patrim√¥nio">
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroNCM">NCM</label>
                        <input type="text" id="cadastroNCM" placeholder="C√≥digo NCM">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="cadastroCategoria">Categoria</label>
                            <select id="cadastroCategoria">
                                <option value="">Selecione</option>
                                <option value="Ferramentas Manuais">Ferramentas Manuais</option>
                                <option value="Ferramentas El√©tricas">Ferramentas El√©tricas</option>
                                <option value="EPI">EPI</option>
                                <option value="Material de Consumo">Material de Consumo</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="cadastroStatus">Status</label>
                            <select id="cadastroStatus">
                                <option value="Dispon√≠vel">Dispon√≠vel</option>
                                <option value="Em Uso">Em Uso</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                                <option value="Danificado">Danificado</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroLocalizacao">Localiza√ß√£o</label>
                        <select id="cadastroLocalizacao">
                            <option value="">Selecione</option>
                            <option value="Almoxarifado Central">Almoxarifado Central</option>
                            <option value="Container El√©trica">Container El√©trica</option>
                            <option value="Container Mec√¢nica">Container Mec√¢nica</option>
                            <option value="Oficina">Oficina</option>
                            <option value="Campo">Campo</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroCondicao">Condi√ß√£o</label>
                        <select id="cadastroCondicao">
                            <option value="Bom">Bom</option>
                            <option value="Regular">Regular</option>
                            <option value="Precisa de Reparo">Precisa de Reparo</option>
                            <option value="Inutiliz√°vel">Inutiliz√°vel</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroNotaFiscal">Nota Fiscal</label>
                        <input type="text" id="cadastroNotaFiscal" placeholder="N√∫mero da nota fiscal">
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroUnidade">Unidade</label>
                        <select id="cadastroUnidade">
                            <option value="UN">UN - Unidade</option>
                            <option value="CX">CX - Caixa</option>
                            <option value="PCT">PCT - Pacote</option>
                            <option value="JT">JT - Jogo</option>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="cadastroQuantidade">Quantidade</label>
                            <input type="number" id="cadastroQuantidade" value="1" min="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="cadastroPreco">Pre√ßo (R$)</label>
                            <input type="number" id="cadastroPreco" step="0.01" placeholder="0,00">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="cadastroEstoqueMin">Estoque M√≠nimo</label>
                            <input type="number" id="cadastroEstoqueMin" value="0" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="cadastroEstoqueMax">Estoque M√°ximo</label>
                            <input type="number" id="cadastroEstoqueMax" value="0" min="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroImagem">Imagem (URL)</label>
                        <input type="text" id="cadastroImagem" placeholder="URL da imagem ou deixe em branco">
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroDescricao">Descri√ß√£o</label>
                        <textarea id="cadastroDescricao" rows="3" placeholder="Descri√ß√£o detalhada..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="cadastroObservacoes">Observa√ß√µes</label>
                        <textarea id="cadastroObservacoes" rows="2" placeholder="Observa√ß√µes adicionais..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px;">
                        <button id="salvarItemBtn" class="mobile-btn" style="background: var(--success-color); color: white;">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                        <button id="limparFormBtn" class="mobile-btn" style="background: var(--warning-color); color: white;">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                    
                    <p style="font-size: 12px; color: var(--gray-color); margin-top: 15px; text-align: center;">
                        * Campos obrigat√≥rios
                    </p>
                </div>
            `;

            document.getElementById('salvarItemBtn').addEventListener('click', saveNewItem);
            document.getElementById('limparFormBtn').addEventListener('click', clearCadastroForm);
        }

        async function saveNewItem() {
            if (!isAdmin()) {
                showNotification('Voc√™ n√£o tem permiss√£o para cadastrar itens', 'error');
                return;
            }

            const nome = document.getElementById('cadastroNome').value.trim();
            const codigo = document.getElementById('cadastroCodigo').value.trim();

            if (!nome || !codigo) {
                showNotification('Preencha nome e c√≥digo!', 'error');
                return;
            }

            const baseUrl = window.location.origin + window.location.pathname;
            const linkUrl = `${baseUrl}?item=${Date.now()}`;

            const novoItem = {
                id: Date.now(),
                name: nome,
                code: codigo,
                patrimonio: document.getElementById('cadastroPatrimonio').value.trim() || null,
                ncm: document.getElementById('cadastroNCM').value.trim() || '',
                category: document.getElementById('cadastroCategoria').value || 'Outros',
                status: document.getElementById('cadastroStatus').value,
                location: document.getElementById('cadastroLocalizacao').value || 'Almoxarifado Central',
                condition: document.getElementById('cadastroCondicao').value || 'Bom',
                notaFiscal: document.getElementById('cadastroNotaFiscal').value.trim() || null,
                unidade: document.getElementById('cadastroUnidade').value || 'UN',
                preco: parseFloat(document.getElementById('cadastroPreco').value) || 0,
                quantidade: parseInt(document.getElementById('cadastroQuantidade').value) || 1,
                estoqueMinimo: parseInt(document.getElementById('cadastroEstoqueMin').value) || 0,
                estoqueMaximo: parseInt(document.getElementById('cadastroEstoqueMax').value) || 0,
                description: document.getElementById('cadastroDescricao').value.trim() || null,
                observations: document.getElementById('cadastroObservacoes').value.trim() || null,
                image: document.getElementById('cadastroImagem').value.trim() || null,
                usuarioCadastro: currentUser ? currentUser.name : 'Mobile User',
                dataCadastro: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                qrCode: linkUrl
            };

            try {
                tools.unshift(novoItem);
                await saveToIndexedDB(tools);

                if (supabaseClient && isOnline) {
                    await saveItemToSupabase(novoItem);
                }

                showNotification('Item cadastrado com sucesso!', 'success');
                clearCadastroForm();
                updateUI();
                switchTab('dashboard');

            } catch (error) {
                console.error('Erro ao salvar:', error);
                showNotification('Erro ao salvar item', 'error');
            }
        }

        function clearCadastroForm() {
            if (!isAdmin()) return;

            if (document.getElementById('cadastroNome')) {
                document.getElementById('cadastroNome').value = '';
                document.getElementById('cadastroCodigo').value = '';
                document.getElementById('cadastroPatrimonio').value = '';
                document.getElementById('cadastroNCM').value = '';
                document.getElementById('cadastroCategoria').value = '';
                document.getElementById('cadastroStatus').value = 'Dispon√≠vel';
                document.getElementById('cadastroLocalizacao').value = '';
                document.getElementById('cadastroCondicao').value = 'Bom';
                document.getElementById('cadastroNotaFiscal').value = '';
                document.getElementById('cadastroUnidade').value = 'UN';
                document.getElementById('cadastroQuantidade').value = '1';
                document.getElementById('cadastroPreco').value = '';
                document.getElementById('cadastroEstoqueMin').value = '0';
                document.getElementById('cadastroEstoqueMax').value = '0';
                document.getElementById('cadastroImagem').value = '';
                document.getElementById('cadastroDescricao').value = '';
                document.getElementById('cadastroObservacoes').value = '';
            }
        }

        async function saveItemToSupabase(item) {
            try {
                const itemData = {
                    name: item.name,
                    code: item.code,
                    patrimonio: item.patrimonio,
                    ncm: item.ncm,
                    category: item.category,
                    status: item.status,
                    location: item.location,
                    condition: item.condition,
                    nota_fiscal: item.notaFiscal,
                    unidade: item.unidade,
                    preco: item.preco,
                    quantidade: item.quantidade,
                    estoque_minimo: item.estoqueMinimo,
                    estoque_maximo: item.estoqueMaximo,
                    description: item.description,
                    observations: item.observations,
                    image_url: item.image,
                    usuario_cadastro: item.usuarioCadastro,
                    data_cadastro: item.dataCadastro,
                    created_at: item.createdAt,
                    updated_at: item.updatedAt,
                    qr_code: item.qrCode
                };

                const { error } = await supabaseClient
                    .from('tools')
                    .insert([itemData]);

                if (error) throw error;

                return true;
            } catch (error) {
                console.error('Erro ao salvar no Supabase:', error);
                return false;
            }
        }

        // ============================================
        // FUN√á√ïES DE MODAL DE ATRIBUI√á√ÉO
        // ============================================
        async function showAssignModal(tool) {
            if (!tool || !isAdmin()) return;

            // Carregar colaboradores se necess√°rio
            if (collaborators.length === 0) {
                await loadCollaborators();
            }

            const modalBody = document.getElementById('assignModalBody');
            document.getElementById('assignModalTitle').textContent = `Atribuir: ${tool.name}`;

            let collaboratorsHtml = '<p style="text-align: center; color: var(--gray-color);">Nenhum colaborador ativo encontrado</p>';

            if (collaborators.length > 0) {
                collaboratorsHtml = '<div style="max-height: 300px; overflow-y: auto;">';
                collaborators.forEach(collab => {
                    collaboratorsHtml += `
                        <div class="collaborator-item" data-id="${collab.id}" onclick="selectCollaborator('${collab.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${collab.name}</strong>
                                    <p style="font-size: 12px; color: var(--gray-color);">${collab.registration} | ${collab.position || 'N/A'}</p>
                                </div>
                                <div style="font-size: 12px; background: var(--light-color); padding: 4px 8px; border-radius: 4px;">
                                    ${collab.sector}
                                </div>
                            </div>
                        </div>
                    `;
                });
                collaboratorsHtml += '</div>';
            }

            modalBody.innerHTML = `
                <div class="tool-assignment-info">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="thumbnail" style="width: 50px; height: 50px;">
                            ${tool.image ? `<img src="${tool.image}" alt="${tool.name}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">` : '<i class="fas fa-tools"></i>'}
                        </div>
                        <div>
                            <h4>${tool.name}</h4>
                            <p style="color: var(--gray-color);">${tool.code} | ${tool.location}</p>
                        </div>
                    </div>
                </div>

                <h4 style="margin-bottom: 15px;">Selecione o Colaborador:</h4>
                
                <div style="margin-bottom: 15px;">
                    <input type="text" id="searchCollaborator" placeholder="Buscar colaborador..." style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                </div>

                <div id="collaboratorsList">
                    ${collaboratorsHtml}
                </div>

                <div class="assignment-actions">
                    <button id="confirmAssignBtn" class="mobile-btn" style="background: var(--assign-color); color: white; flex: 2;" disabled>
                        <i class="fas fa-check"></i> Confirmar Atribui√ß√£o
                    </button>
                    <button id="cancelAssignBtn" class="mobile-btn" style="background: var(--gray-color); color: white; flex: 1;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            `;

            document.getElementById('assignModal').style.display = 'flex';
            assignmentInProgress = { tool, selectedCollaboratorId: null };

            // Adicionar eventos
            document.getElementById('searchCollaborator').addEventListener('input', function() {
                const term = this.value.toLowerCase();
                filterCollaborators(term);
            });

            document.getElementById('cancelAssignBtn').addEventListener('click', closeAssignModal);

            document.getElementById('confirmAssignBtn').addEventListener('click', async function() {
                if (assignmentInProgress && assignmentInProgress.selectedCollaboratorId) {
                    const success = await assignTool(
                        assignmentInProgress.tool.id, 
                        assignmentInProgress.selectedCollaboratorId
                    );
                    
                    if (success) {
                        closeAssignModal();
                        switchTab('assignments');
                    }
                }
            });
        }

        function selectCollaborator(collaboratorId) {
            // Remover sele√ß√£o anterior
            document.querySelectorAll('.collaborator-item').forEach(el => {
                el.classList.remove('selected');
            });

            // Adicionar sele√ß√£o ao item clicado
            const selectedEl = document.querySelector(`.collaborator-item[data-id="${collaboratorId}"]`);
            if (selectedEl) {
                selectedEl.classList.add('selected');
            }

            // Atualizar vari√°vel de controle
            if (assignmentInProgress) {
                assignmentInProgress.selectedCollaboratorId = collaboratorId;
            }

            // Habilitar bot√£o de confirma√ß√£o
            document.getElementById('confirmAssignBtn').disabled = false;
        }

        function filterCollaborators(term) {
            const items = document.querySelectorAll('.collaborator-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(term)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ============================================
        // FUN√á√ïES DE VERIFICA√á√ÉO DE URL
        // ============================================
        function checkUrlForItem() {
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('item');

            console.log('Verificando URL para item:', itemId);

            if (itemId && currentUser) {
                setTimeout(() => {
                    console.log('Buscando item da URL:', itemId);

                    buscarItemLocal(itemId).then(tool => {
                        if (tool) {
                            console.log('Item da URL encontrado:', tool);
                            showToolDetails(tool.id);

                            window.history.replaceState({}, document.title, window.location.pathname);
                        } else {
                            console.log('Item da URL n√£o encontrado localmente');

                            if (supabaseClient) {
                                showNotification('Buscando item da URL na nuvem...', 'info');
                                buscarItemNoSupabase(itemId, null, (tool) => {
                                    if (tool) {
                                        showToolDetails(tool.id);
                                    }
                                });
                            }
                        }
                    });
                }, 2000);
            }
        }

        // ============================================
        // FUN√á√ïES DE INICIALIZA√á√ÉO
        // ============================================
        async function initializeSystem() {
            console.log('üîß Inicializando sistema...');

            try {
                await initIndexedDB();
                tools = await loadFromIndexedDB(999999);
                console.log(`üìÅ ${tools.length} itens carregados`);

                await connectToSupabase();

                // Carregar colaboradores e atribui√ß√µes
                await loadCollaborators();
                await loadAssignments();

                updateUI();
                updateSyncInfo();

                // Se for colaborador, carregar minhas atribui√ß√µes
                if (isCollaborator()) {
                    updateMyAssignmentsCard();
                }

                if (isOnline && supabaseClient && isAdmin()) {
                    console.log('üîÑ Sincronizando com a nuvem...');
                    showNotification('Sincronizando dados...', 'info');

                    const result = await fetchAllFromSupabase();

                    if (result.success) {
                        updateUI();
                        showNotification(`${result.count} itens sincronizados!`, 'success');
                    }
                }

            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                showNotification('Erro ao inicializar', 'error');
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM carregado');
            setupEventListeners();
            checkSession();
        });

        function setupEventListeners() {
            console.log('Configurando eventos...');

            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }

            const menuBtn = document.getElementById('menuBtn');
            if (menuBtn) {
                menuBtn.addEventListener('click', openMenu);
            }

            const menuOverlay = document.getElementById('menuOverlay');
            if (menuOverlay) {
                menuOverlay.addEventListener('click', closeMenu);
            }

            const startScannerBtn = document.getElementById('startScannerBtn');
            if (startScannerBtn) {
                startScannerBtn.addEventListener('click', startScanner);
            }

            const stopScannerBtn = document.getElementById('stopScannerBtn');
            if (stopScannerBtn) {
                stopScannerBtn.addEventListener('click', stopScanner);
            }

            const viewScannedItemBtn = document.getElementById('viewScannedItemBtn');
            if (viewScannedItemBtn) {
                viewScannedItemBtn.addEventListener('click', function() {
                    if (currentScannedTool) {
                        closeItemModal();
                        showToolDetails(currentScannedTool.id);
                    }
                });
            }

            const assignScannedItemBtn = document.getElementById('assignScannedItemBtn');
            if (assignScannedItemBtn) {
                assignScannedItemBtn.addEventListener('click', function() {
                    if (currentScannedTool && isAdmin()) {
                        stopScanner();
                        showAssignModal(currentScannedTool);
                    }
                });
            }

            const collabTakeItemBtn = document.getElementById('collabTakeItemBtn');
            if (collabTakeItemBtn) {
                collabTakeItemBtn.addEventListener('click', async function() {
                    if (currentScannedTool && isCollaborator()) {
                        stopScanner();
                        const success = await takeToolAsCollaborator(currentScannedTool.id);
                        if (success) {
                            switchTab('assignments');
                        }
                    }
                });
            }

            const scanAgainBtn = document.getElementById('scanAgainBtn');
            if (scanAgainBtn) {
                scanAgainBtn.addEventListener('click', function() {
                    document.getElementById('scannerResult').style.display = 'none';
                    currentScannedTool = null;
                    startScanner();
                });
            }

            const syncNowBtn = document.getElementById('syncNowBtn');
            if (syncNowBtn) {
                syncNowBtn.addEventListener('click', async () => {
                    if (isAdmin()) {
                        await fetchAllFromSupabase();
                    } else {
                        showNotification('Apenas administradores podem sincronizar', 'warning');
                    }
                });
            }

            const syncAllBtn = document.getElementById('syncAllBtn');
            if (syncAllBtn) {
                syncAllBtn.addEventListener('click', async () => {
                    if (isAdmin() && confirm('Buscar TODOS os itens?')) {
                        await fetchAllFromSupabase();
                    }
                });
            }

            const syncUpdatesBtn = document.getElementById('syncUpdatesBtn');
            if (syncUpdatesBtn) {
                syncUpdatesBtn.addEventListener('click', async () => {
                    showNotification('Funcionalidade em desenvolvimento', 'info');
                });
            }

            const clearCacheBtn = document.getElementById('clearCacheBtn');
            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', async () => {
                    if (isAdmin() && confirm('Limpar cache?')) {
                        if (db) {
                            const transaction = db.transaction([STORE_NAME], 'readwrite');
                            const store = transaction.objectStore(STORE_NAME);
                            store.clear();
                            tools = [];
                            updateUI();
                            showNotification('Cache limpo', 'success');
                        }
                    }
                });
            }

            const addItemBtn = document.getElementById('addItemBtn');
            if (addItemBtn) {
                addItemBtn.addEventListener('click', () => {
                    if (isAdmin()) {
                        switchTab('cadastro');
                    }
                });
            }

            const collabScanBtn = document.getElementById('collabScanBtn');
            if (collabScanBtn) {
                collabScanBtn.addEventListener('click', () => {
                    if (isCollaborator()) {
                        switchTab('scanner');
                        showNotification('Escaneie o QR Code da ferramenta que deseja pegar', 'info');
                    }
                });
            }

            const assignToolBtn = document.getElementById('assignToolBtn');
            if (assignToolBtn) {
                assignToolBtn.addEventListener('click', () => {
                    if (isAdmin()) {
                        switchTab('scanner');
                        showNotification('Escaneie o QR Code da ferramenta para atribuir', 'info');
                    }
                });
            }

            const viewAllBtn = document.getElementById('viewAllBtn');
            if (viewAllBtn) {
                viewAllBtn.addEventListener('click', () => {
                    switchTab('catalogo');
                });
            }

            const showActiveAssignments = document.getElementById('showActiveAssignments');
            if (showActiveAssignments) {
                showActiveAssignments.addEventListener('click', () => {
                    showAssignmentsList(true);
                });
            }

            const showAllAssignments = document.getElementById('showAllAssignments');
            if (showAllAssignments) {
                showAllAssignments.addEventListener('click', () => {
                    showAssignmentsList(false);
                });
            }

            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    searchTimeout = setTimeout(() => {
                        updateToolsList();
                    }, 300);
                });
            }

            const saveConfigBtn = document.getElementById('saveConfigBtn');
            if (saveConfigBtn) {
                saveConfigBtn.addEventListener('click', () => {
                    showNotification('Configura√ß√µes salvas!', 'success');
                });
            }

            setupModalEvents();

            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus(true);
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus(false);
            });
        }
    </script>
</body>

</html>
